(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const qn="modulepreload",Un=function(t){return"/"+t},ln={},un=function(e,n,a){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));o=Promise.allSettled(n.map(p=>{if(p=Un(p),p in ln)return;ln[p]=!0;const m=p.endsWith(".css"),h=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${h}`))return;const r=document.createElement("link");if(r.rel=m?"stylesheet":qn,m||(r.as="script"),r.crossOrigin="",r.href=p,u&&r.setAttribute("nonce",u),document.head.appendChild(r),m)return new Promise((f,P)=>{r.addEventListener("load",f),r.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${p}`)))})}))}function s(l){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=l,window.dispatchEvent(u),!u.defaultPrevented)throw l}return o.then(l=>{for(const u of l||[])u.status==="rejected"&&s(u.reason);return e().catch(s)})},d=t=>document.getElementById(t),ot=(t,e,n)=>t&&t.addEventListener(e,n),vt=window.devicePixelRatio||1,ct=(t,e="warn")=>{const n=d("status");n.hidden=!1,n.className="status "+e,n.textContent=t,console.log("[status]",t)},le=(t,e,n)=>Math.abs(t-e)<=n,Bn=(t,e,n)=>Math.min(Math.max(t,e),n);function zn(t,e,n,a){const o=e.getBoundingClientRect(),s=(n-o.left)*vt,l=(a-o.top)*vt,u=(s-t.pan.x)/(t.zoom*vt),p=(e.height-l-t.pan.y)/(t.zoom*vt);return{x:u,y:p,sx:s,sy:l}}let xt=null;const bn={cutting:{power:"1.0",gas:"air",thickness:1,cutSpeed:1400,pierceTime:1.5},pricing:{currency:"RUB",machineHourPrice:0,markupPercent:100,byThickness:{"0.5":{pierce:.2,cutPerMm:.0025},"0.6":{pierce:.2,cutPerMm:.0025},"0.8":{pierce:.2,cutPerMm:.0025},"1.0":{pierce:.3,cutPerMm:.004},"1.5":{pierce:.4,cutPerMm:.01},"2.0":{pierce:.8,cutPerMm:.015},"3.0":{pierce:1.2,cutPerMm:.03},"5.0":{pierce:2.2,cutPerMm:.1},"6.0":{pierce:3.2,cutPerMm:.15}}},sheet:{width:1250,height:2500,margin:10,spacing:5,quantity:1},nesting:{rotations:"0,90"},ui:{defaultTab:"orig",canvasHeight:600,showTooltips:!0},parser:{tolerance:.1,closureTolerance:null},annotations:{maxPierceLabels:0}};function jn(t){const e=[],n=[];if(!t||typeof t!="object")return e.push("Configuration must be an object"),{isValid:!1,errors:e,warnings:n};if(t.cutting){const a=["0.5","1.0","1.5","2.0"];t.cutting.power&&!a.includes(String(t.cutting.power))&&n.push(`Invalid power value: ${t.cutting.power}. Valid values: ${a.join(", ")}`);const o=["oxygen","nitrogen","air"];t.cutting.gas&&!o.includes(t.cutting.gas)&&n.push(`Invalid gas value: ${t.cutting.gas}. Valid values: ${o.join(", ")}`);const s=[.5,.6,.7,.8,1,1.5,2,3,5,6];t.cutting.thickness&&!s.includes(Number(t.cutting.thickness))&&n.push(`Invalid thickness: ${t.cutting.thickness}. Valid values: ${s.join(", ")}`)}return t.pricing&&["pricePerMeter","pricePerPierce","gasPricePerMinute","machineHourPrice"].forEach(o=>{t.pricing[o]&&(isNaN(t.pricing[o])||t.pricing[o]<0)&&n.push(`Invalid ${o}: must be a positive number`)}),t.sheet&&(["width","height","margin","spacing"].forEach(o=>{t.sheet[o]&&(isNaN(t.sheet[o])||t.sheet[o]<=0)&&n.push(`Invalid sheet ${o}: must be a positive number`)}),t.sheet.quantity&&(isNaN(t.sheet.quantity)||t.sheet.quantity<1)&&n.push("Invalid quantity: must be a positive integer >= 1")),{isValid:e.length===0,errors:e,warnings:n}}async function dn(){try{console.log("Loading configuration from config.json...");const t=await fetch("./config.json");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const e=await t.json(),n=jn(e);if(!n.isValid)throw console.error("Configuration validation errors:",n.errors),new Error(`Invalid configuration: ${n.errors.join(", ")}`);return n.warnings.length>0&&console.warn("Configuration validation warnings:",n.warnings),xt=e,console.log("Configuration loaded and validated successfully:",xt),xt}catch(t){return console.warn("Failed to load config.json, using default configuration:",t),xt={...bn},xt}}function kt(){return xt||bn}function Ee(t,e=null){const n=kt(),a=t.split(".");let o=n;for(const s of a)if(o&&typeof o=="object"&&s in o)o=o[s];else return e;return o}function Me(t){const e=kt(),n=String(t),a=Number(t);if(e.pricing&&e.pricing.byThickness){const s=e.pricing.byThickness;let l=s[n];if(!l){const u=Object.keys(s).find(p=>Number(p)===a);u&&(l=s[u])}if(l){const u=Number.isFinite(l.cutPerMm)?l.cutPerMm:Number.isFinite(l.cut_per_mm)?l.cut_per_mm:0;return{pierce:l.pierce||0,cutPerM:u*1e3,cutPerMm:u,currency:e.pricing.currency||"RUB",machineHourPrice:e.pricing.machineHourPrice||0,markupPercent:e.pricing.markupPercent||100}}}const o=e.pricingMD;if(o&&o.table&&o.table[n]){const s=o.table[n];return{pierce:s.pierce||0,cutPerM:s.cut_per_m||(s.cut_per_mm||0)*1e3,cutPerMm:s.cut_per_mm||(s.cut_per_m||0)/1e3,currency:o.currency||"RUB",machineHourPrice:o.machineHourPrice||0,markupPercent:o.markupPercent||100}}return null}function Le(){const t=kt();return t.pricing&&t.pricing.currency?t.pricing.currency:t.pricingMD&&t.pricingMD.currency?t.pricingMD.currency:"RUB"}function Vn(t){const e=kt();try{t.power&&(t.power.value=e.cutting.power),t.gas&&(t.gas.value=e.cutting.gas),t.thickness&&(t.thickness.value=e.cutting.thickness);const n=Number(e.cutting.thickness),a=Me(n),o=e.pricing&&Number.isFinite(e.pricing.markupPercent)?1+e.pricing.markupPercent/100:1;t.pricePerMeter&&(t.pricePerMeter.value=a?a.cutPerMm*1e3*o:0),t.pricePerPierce&&(t.pricePerPierce.value=a?a.pierce*o:0),t.gasPricePerMinute&&(t.gasPricePerMinute.value=0),t.machineHourPrice&&(t.machineHourPrice.value=e.pricing&&e.pricing.machineHourPrice?e.pricing.machineHourPrice:0),t.sheetWidth&&(t.sheetWidth.value=e.sheet.width),t.sheetHeight&&(t.sheetHeight.value=e.sheet.height),t.margin&&(t.margin.value=e.sheet.margin),t.spacing&&(t.spacing.value=e.sheet.spacing),t.quantity&&(t.quantity.value=e.sheet.quantity),t.rotations&&(t.rotations.value=e.nesting.rotations),console.log("Configuration applied to form elements successfully")}catch(n){console.error("Error applying configuration to form:",n)}}function Gn(t){try{if(xt){if(Object.assign(xt.cutting,{power:t.power||xt.cutting.power,gas:t.gas||xt.cutting.gas,thickness:parseFloat(t.thickness)||xt.cutting.thickness}),typeof t.machineHourPrice<"u"){const e=parseFloat(t.machineHourPrice);Number.isNaN(e)||(xt.pricing.machineHourPrice=e)}Object.assign(xt.sheet,{width:parseInt(t.sheetWidth)||xt.sheet.width,height:parseInt(t.sheetHeight)||xt.sheet.height,margin:parseInt(t.margin)||xt.sheet.margin,spacing:parseInt(t.spacing)||xt.sheet.spacing,quantity:parseInt(t.quantity)||xt.sheet.quantity}),t.rotations&&(xt.nesting.rotations=t.rotations)}localStorage.setItem("dxf-pro-config",JSON.stringify(xt)),console.log("Configuration saved to localStorage")}catch(e){console.error("Error saving configuration:",e)}}function $e(){try{const t=localStorage.getItem("dxf-pro-config");if(t){const e=JSON.parse(t);return console.log("Configuration loaded from localStorage:",e),e}}catch(t){console.warn("Failed to load configuration from localStorage:",t)}return null}const Fe={.5:{max:{oxygen:6,nitrogen:3,air:4},pierce:{oxygen:2,nitrogen:1.5,air:2.5}},1:{max:{oxygen:10,nitrogen:6,air:8},pierce:{oxygen:1.5,nitrogen:1,air:2}},1.5:{max:{oxygen:15,nitrogen:10,air:12},pierce:{oxygen:1.2,nitrogen:.8,air:1.5}},2:{max:{oxygen:25,nitrogen:20,air:18},pierce:{oxygen:1,nitrogen:.6,air:1.2}}};function Jn(t,e,n){const a=[];return typeof t>"u"||t===null||t===""?a.push("Не указана мощность лазера"):typeof t!="number"||!isFinite(t)||t<=0?a.push("Мощность должна быть положительным числом"):Fe[t]||a.push(`Неподдерживаемая мощность: ${t} кВт`),typeof e>"u"||e===null||isNaN(e)?a.push("Не указана толщина металла"):typeof e!="number"||!isFinite(e)||e<=0?a.push("Толщина должна быть положительным числом"):e>50&&a.push("Толщина слишком большая (>50 мм)"),typeof n>"u"||n===null||n===""?a.push("Не указан тип газа"):(typeof n!="string"||!["oxygen","nitrogen","air"].includes(n))&&a.push(`Неподдерживаемый тип газа: ${n}`),{isValid:a.length===0,errors:a}}function zt(t,e,n){typeof t=="string"&&(t=parseFloat(t)),typeof e=="string"&&(e=parseFloat(e)),console.log("calcCutParams called with:",{power:t,th:e,gas:n,types:{power:typeof t,th:typeof e,gas:typeof n}});const a=Jn(t,e,n);if(!a.isValid)return console.warn("Validation failed:",a.errors),{can:!1,reason:a.errors.join("; ")};try{const s=Fe[t].max[n];if(e>s)return{can:!1,reason:`Недостаточная мощность для ${e} мм (${n}). Максимум: ${s} мм`};const l={"0.5":3500,"0.6":3200,"0.7":3e3,"0.8":2800,1:2500,"1.5":2e3,2:1600,3:1200,5:800,6:600},u={"0.5":.7,"1.0":1,"1.5":1.4,"2.0":1.8},p=(k,T)=>{if(!k)return;const Q=String(T);if(Q in k)return k[Q];const nt=Number(T),ht=Object.keys(k).find(ut=>Number(ut)===nt);return ht?k[ht]:void 0},m=Ee("cutting.baseCutSpeeds",l),h=Ee("cutting.powerMultipliers",u),r=Ee("cutting.cutSpeeds",l);let f=p(r,e);if(!Number.isFinite(f)||f<=0){const k=p(m,e),T=p(h,t);Number.isFinite(k)&&Number.isFinite(T)&&(f=Math.round(k*T))}(!Number.isFinite(f)||f<=0)&&(f=Math.max(Math.round(2e3*Math.pow(1-e/(s*1.5),.6)),100));const P=Ee("cutting.byThickness",null),x=p(P,e),b=x&&Number.isFinite(x.pierceSec)?Number(x.pierceSec):NaN;if(!Number.isFinite(b)||b<=0)return{can:!1,reason:`CONFIG_PIERCE_NOT_FOUND: cutting.byThickness[${e}]`};const v={nitrogen:4,oxygen:2,air:1},L=Math.max(.1,e/3*v[n]);return{can:!0,speed:Math.round(f),pierce:Math.round(b*100)/100,gasCons:Math.round(L*100)/100}}catch(o){return console.error("Ошибка в calcCutParams:",o),{can:!1,reason:`Ошибка расчёта: ${o.message}`}}}function Kn(){return Object.keys(Fe).map(Number).sort((t,e)=>t-e)}function Qn(){return["oxygen","nitrogen","air"]}function Zn(t,e){try{const n=Fe[t];return n&&n.max[e]||null}catch(n){return console.error("Ошибка в getMaxThickness:",n),null}}function Oe(t,e,n){const a=Math.max(1e-9,Number(t)||0),o=Math.max(1e-9,Number(e)||.001),s=Math.max(1e-6,Math.abs(Number(n)||0)),l=Math.max(-1,Math.min(1,1-o/a)),u=Math.max(1e-4,2*Math.acos(l));return Math.ceil(Math.max(8,Math.min(2048,s/u)))}function ti(t,e){let n=t,a=e;t&&typeof t=="object"&&typeof t.text=="string"?(n=t.text,a=t.options||a):n=String(t||"");const o=Math.max(1e-6,Number((a&&a.tolerance)??.1)),s=Math.max(1e-6,Number((a&&a.closureTolerance)??o)),l=!!(a&&a.strictUnsupported),u=new Map;function p({cx:i,cy:c,mx:y,my:w,ratio:g=1,startParam:F=0,endParam:O=2*Math.PI}){const X=JSON.stringify({cx:i,cy:c,mx:y,my:w,ratio:g,startParam:F,endParam:O,tol:o,ct:s});if(u.has(X))return u.get(X);const N=i*T,D=c*T,I=y*T,U=w*T,_=Math.hypot(I,U);if(!(_>0)||!(g>0))return{pts:[],closed:!1,lenM:0};const B=I/_,q=U/_,et=-q,bt=B,lt=_*g;let it=Number.isFinite(F)?F:0,at=Number.isFinite(O)?O:2*Math.PI;for(;at<it;)at+=2*Math.PI;const mt=Math.max(0,Math.min(2*Math.PI,at-it)),tt=Math.pow(_-lt,2)/Math.pow(_+lt,2),$=Math.PI*(_+lt)*(1+3*tt/(10+Math.sqrt(4-3*tt)))*(mt/(2*Math.PI)),S=Math.max(8,Math.min(2048,Math.ceil($/Math.max(o,1e-6)))),A=[];for(let G=0;G<=S;G++){const J=it+mt*(G/S),Ft=N+_*Math.cos(J)*B+lt*Math.sin(J)*et,Yt=D+_*Math.cos(J)*q+lt*Math.sin(J)*bt;A.push({x:Ft,y:Yt})}const H=mt>=2*Math.PI-.001||Math.hypot(A[0].x-A[A.length-1].x,A[0].y-A[A.length-1].y)<=s;let z=0;for(let G=0;G<A.length-1;G++)z+=Math.hypot(A[G+1].x-A[G].x,A[G+1].y-A[G].y);H&&(z+=Math.hypot(A[0].x-A[A.length-1].x,A[0].y-A[A.length-1].y));const W={pts:A,closed:H,lenM:z/1e3};return u.set(X,W),W}const m=new Map;function h(i){const c=JSON.stringify({deg:Number.isFinite(i.degree)?i.degree:3,ctrl:i.ctrlPts||[],fit:i.fitPts||[],knots:i.knots||[],flags:i.flags||0,weights:i.weights||[],tol:o,ct:s});if(m.has(c))return m.get(c);const y=Number.isFinite(i.degree)?i.degree:3,w=(i.ctrlPts||[]).map(_=>({x:_.x*T,y:_.y*T})),g=(i.fitPts||[]).map(_=>({x:_.x*T,y:_.y*T})),F=Array.isArray(i.knots)?i.knots.slice():[],O=Array.isArray(i.weights)?i.weights.slice():void 0;let X=[];function N(_){let B=0;for(let q=0;q<_.length-1;q++)B+=Math.hypot(_[q+1].x-_[q].x,_[q+1].y-_[q].y);return B}if(g.length>=2){for(let _=0;_<g.length-1;_++){const B=g[_],q=g[_+1],et=Math.hypot(q.x-B.x,q.y-B.y),bt=Math.max(1,Math.ceil(et/Math.max(o,1e-6)));for(let lt=0;lt<bt;lt++){const it=lt/bt;X.push({x:B.x+(q.x-B.x)*it,y:B.y+(q.y-B.y)*it})}}X.push(g[g.length-1])}else if(w.length>=y+1&&F.length>=w.length+y+1){let bt=function(it){let at=y,mt=F.length-y-1;if(it>=F[mt])return mt-1;if(it<=F[at])return at;let tt=Math.floor((at+mt)/2);for(;it<F[tt]||it>=F[tt+1];)it<F[tt]?mt=tt:at=tt,tt=Math.floor((at+mt)/2);return tt},lt=function(it){const at=bt(it),mt=Array.isArray(O)&&O.length===w.length,tt=[];if(mt){for(let S=0;S<=y;S++){const A=Number(O[at-y+S])||0,H=w[at-y+S];tt[S]={x:H.x*A,y:H.y*A,w:A}}for(let S=1;S<=y;S++)for(let A=y;A>=S;A--){const H=at-y+A,z=F[H+1]-F[H-S+1],W=z!==0?(it-F[H-S+1])/z:0,G=(1-W)*tt[A-1].x+W*tt[A].x,J=(1-W)*tt[A-1].y+W*tt[A].y,Ft=(1-W)*tt[A-1].w+W*tt[A].w;tt[A]={x:G,y:J,w:Ft}}const R=tt[y],$=R.w||0;return Math.abs($)>1e-12?{x:R.x/$,y:R.y/$}:{x:w[at].x,y:w[at].y}}else{for(let R=0;R<=y;R++)tt[R]={x:w[at-y+R].x,y:w[at-y+R].y};for(let R=1;R<=y;R++)for(let $=y;$>=R;$--){const S=at-y+$,A=F[S+1]-F[S-R+1],H=A!==0?(it-F[S-R+1])/A:0,z=(1-H)*tt[$-1].x+H*tt[$].x,W=(1-H)*tt[$-1].y+H*tt[$].y;tt[$]={x:z,y:W}}return tt[y]}};const _=F[y],B=F[F.length-y-1],q=N(w),et=Math.max(16,Math.min(4096,Math.ceil(q/Math.max(o,1e-6))));for(let it=0;it<=et;it++){const at=_+(B-_)*(it/et);X.push(lt(at))}}else X=w.slice();const D=!!(i.flags&1)||X.length>1&&Math.hypot(X[0].x-X[X.length-1].x,X[0].y-X[X.length-1].y)<=s;let I=0;for(let _=0;_<X.length-1;_++)I+=Math.hypot(X[_+1].x-X[_].x,X[_+1].y-X[_].y);D&&X.length>1&&(I+=Math.hypot(X[0].x-X[X.length-1].x,X[0].y-X[X.length-1].y));const U={pts:X,closed:D,lenM:I/1e3};return m.set(c,U),U}const r=n.split(/\r?\n/),f=r.length;let P=0;function x(){if(P+1>=f)return null;const i=parseInt((r[P++]||"").trim(),10),c=(r[P++]||"").trim();return Number.isNaN(i)?x():{code:i,value:c}}const b=i=>String(i||"").toUpperCase();function v(i){try{for(let c=1;c<i.length-1;c++){const y=(i[c]||"").trim(),w=(i[c-1]||"").trim();if(y==="$INSUNITS"&&w==="9")for(let g=c+1;g<Math.min(c+50,i.length-1);g+=2){const F=(i[g]||"").trim(),O=(i[g+1]||"").trim();if(F==="70"){const X=parseInt(O,10);return Number.isFinite(X)?X:null}}}}catch{}}function L(i){switch(i){case 1:return 25.4;case 2:return 304.8;case 3:return 1609344;case 4:return 1;case 5:return 10;case 6:return 1e3;case 7:return 1e6;case 8:return 254e-7;case 9:return .0254;case 10:return 914.4;case 11:return 1e-7;case 12:return 1e-6;case 13:return .001;case 14:return 100;case 15:return 1e4;case 16:return 1e5;default:return 1}}const k=v(r),T=L(k);function Q(i){try{let c=null,y=null,w=null,g=null;for(let F=1;F<i.length-1;F++){const O=(i[F]||"").trim(),X=(i[F-1]||"").trim();if(O==="$EXTMIN"&&X==="9")for(let N=F+1;N<Math.min(F+50,i.length-1);N+=2){const D=(i[N]||"").trim(),I=(i[N+1]||"").trim();if(D==="10"?c=parseFloat(I):D==="20"&&(y=parseFloat(I)),c!==null&&y!==null)break}if(O==="$EXTMAX"&&X==="9")for(let N=F+1;N<Math.min(F+50,i.length-1);N+=2){const D=(i[N]||"").trim(),I=(i[N+1]||"").trim();if(D==="10"?w=parseFloat(I):D==="20"&&(g=parseFloat(I)),w!==null&&g!==null)break}}return{minX:c,minY:y,maxX:w,maxY:g}}catch{return{minX:null,minY:null,maxX:null,maxY:null}}}const nt=Q(r);function ht(i){try{const c=[];let y=0,w=!1,g=!1;for(;y<i.length-1;){const F=(i[y]||"").trim(),O=(i[y+1]||"").trim();if(F==="0"&&O==="SECTION"&&(w=!1,g=!1),F==="2"&&O==="TABLES"&&(w=!0),w&&F==="0"&&O==="TABLE"){const X=(i[y+2]||"").trim(),N=(i[y+3]||"").trim();g=X==="2"&&N==="LAYER"}if(F==="0"&&O==="ENDSEC"&&(w=!1,g=!1),w&&g&&F==="0"&&O==="LAYER"){let X="",N=7,D=0,I=y+2;for(;I<i.length-1;I+=2){const _=(i[I]||"").trim(),B=(i[I+1]||"").trim();if(_==="0")break;_==="2"?X=B||X:_==="62"?N=parseInt(B||"7",10):_==="70"&&(D=parseInt(B||"0",10))}const U=N>=0&&(D&1)===0;X&&U&&c.push(X)}y+=2}return c}catch{return[]}}let ut,pt=!1;for(;ut=x();)if(ut.code===0&&b(ut.value)==="SECTION"){let i=null,c;for(;c=x();)if(c.code===2)i=b(c.value);else if(c.code===0){P-=2;break}if(i==="ENTITIES"){pt=!0;break}}if(!pt)throw new Error("Нет секции ENTITIES");function _t(i){const c=[],y=new Map;for(let N=0;N<i.length-1;N++){const D=(i[N]||"").trim(),I=(i[N-1]||"").trim();if(D==="BLOCK"&&I==="0"){let U=null,_={x:0,y:0};for(let B=N+1;B<i.length-1;B+=2){const q=(i[B]||"").trim(),et=(i[B+1]||"").trim();if(q==="2"&&!U&&(U=et),q==="10"&&(_.x=parseFloat(et)),q==="20"&&(_.y=parseFloat(et)),q==="0"&&(et||"").trim().toUpperCase()==="ENDBLK"){N=B+1;break}}if(U){const B={name:U,basePoint:_,ents:[]};c.push(B),y.set(U,B)}}}let w=0,g=null,F=null,O=null;function X(N){return String(N||"").toUpperCase()}for(;w<i.length-1;){const N=(i[w]||"").trim(),D=(i[w+1]||"").trim();if(w+=2,N==="0"&&X(D)==="BLOCK"){g=null,F=null,O={name:null,base:{x:0,y:0}};continue}if(O){if(N==="2"&&!O.name){O.name=D;continue}if(N==="10"){O.base.x=parseFloat(D);continue}if(N==="20"){O.base.y=parseFloat(D);continue}if(N==="0"&&X(D)==="ENDBLK"){if(g&&F!==g){const _=y.get(O.name||"");_&&_.ents.push(g)}if(F){const _=y.get(O.name||"");_&&_.ents.push(F)}const U=y.get(O.name||"");U&&(U.basePoint=O.base),O=null,g=null,F=null;continue}if(N==="0"){const U=X(D);if(U==="VERTEX"&&F)g=F;else if(U==="SEQEND"&&F){const _=y.get(O.name||"");_&&_.ents.push(F),F=null,g=null;continue}else{if(g&&F!==g){const _=y.get(O.name||"");_&&_.ents.push(g)}g={type:U,data:{},verts:[]},U==="POLYLINE"&&(F=g)}continue}if(!g)continue;if(N==="8"){g.data.layer=(D||"").trim();continue}if(N==="62"){g.data.colorIndex=parseInt(D,10);continue}if(N==="6"){g.data.linetype=D;continue}if(N==="370"){g.data.lineweight=parseInt(D,10);continue}const I=parseFloat(D);switch(g.type){case"LINE":N==="10"?g.data.x1=I:N==="20"?g.data.y1=I:N==="11"?g.data.x2=I:N==="21"&&(g.data.y2=I);break;case"CIRCLE":N==="10"?g.data.cx=I:N==="20"?g.data.cy=I:N==="40"&&(g.data.r=I);break;case"ARC":N==="10"?g.data.cx=I:N==="20"?g.data.cy=I:N==="40"?g.data.r=I:N==="50"?g.data.a1=I:N==="51"&&(g.data.a2=I);break;case"LWPOLYLINE":N==="10"?g.verts.push({x:I}):N==="20"?g.verts.length&&(g.verts[g.verts.length-1].y=I):N==="42"?g.verts.length&&(g.verts[g.verts.length-1].bulge=I):N==="70"&&(g.data.flags=parseInt(D,10));break;case"POLYLINE":case"VERTEX":N==="10"?g.verts.push({x:I}):N==="20"?g.verts.length&&(g.verts[g.verts.length-1].y=I):N==="42"?g.verts.length&&(g.verts[g.verts.length-1].bulge=I):N==="70"&&(g.data.flags=parseInt(D,10));break;case"ELLIPSE":N==="10"?g.data.cx=I:N==="20"?g.data.cy=I:N==="11"?g.data.mx=I:N==="21"?g.data.my=I:N==="40"?g.data.ratio=I:N==="41"?g.data.t1=I:N==="42"&&(g.data.t2=I);break;case"SPLINE":if(N==="70")g.data.flags=parseInt(D,10);else if(N==="71")g.data.degree=parseInt(D,10);else if(N==="40")g.data.knots||(g.data.knots=[]),g.data.knots.push(I);else if(N==="10")g.data.ctrlPts||(g.data.ctrlPts=[]),g.data.ctrlPts.push({x:I});else if(N==="20"){const U=g.data.ctrlPts;U&&U.length&&(U[U.length-1].y=I)}else if(N==="11")g.data.fitPts||(g.data.fitPts=[]),g.data.fitPts.push({x:I});else if(N==="21"){const U=g.data.fitPts;U&&U.length&&(U[U.length-1].y=I)}break;case"POINT":N==="10"?g.data.x=I:N==="20"&&(g.data.y=I);break;case"INSERT":N==="2"?g.data.name=D:N==="10"?g.data.x=I:N==="20"?g.data.y=I:N==="41"?g.data.sx=I:N==="42"?g.data.sy=I:N==="50"&&(g.data.rot=I);break}}}return{blocks:c,map:y}}const wt=_t(r),Tt=[];let E,M=null,gt=null;const Lt=[],It=[],Jt=[],Kt=[],Qt=[],yt=[],oe=new Set(["LINE","CIRCLE","ARC","LWPOLYLINE","POLYLINE","VERTEX","SEQEND","ELLIPSE","SPLINE","POINT","INSERT","TEXT","MTEXT","DIMENSION","LEADER","HATCH"]);for(;(E=x())&&!(E.code===0&&b(E.value)==="ENDSEC");){if(E.code===0){const c=b(E.value);if(c==="VERTEX"&&gt)M=gt;else if(c==="SEQEND"&&gt){Tt.push(gt),gt=null,M=null;continue}else M&&M!==gt&&(oe.has(M.type)?Tt.push(M):Tt.push({type:M.type,data:M.data||{},unsupported:!0})),M={type:c,data:{},verts:[]},c==="POLYLINE"&&(gt=M);continue}if(!M)continue;if(E.code===8){M.data.layer=(E.value||"").trim();continue}const i=parseFloat(E.value);switch(M.type){case"LINE":E.code===10?M.data.x1=i:E.code===20?M.data.y1=i:E.code===11?M.data.x2=i:E.code===21&&(M.data.y2=i);break;case"CIRCLE":E.code===10?M.data.cx=i:E.code===20?M.data.cy=i:E.code===40&&(M.data.r=i);break;case"ARC":E.code===10?M.data.cx=i:E.code===20?M.data.cy=i:E.code===40?M.data.r=i:E.code===50?M.data.a1=i:E.code===51&&(M.data.a2=i);break;case"LWPOLYLINE":E.code===10?M.verts.push({x:i}):E.code===20?M.verts.length&&(M.verts[M.verts.length-1].y=i):E.code===42?M.verts.length&&(M.verts[M.verts.length-1].bulge=i):E.code===70&&(M.data.flags=parseInt(E.value,10));break;case"POLYLINE":case"VERTEX":E.code===10?M.verts.push({x:i}):E.code===20?M.verts.length&&(M.verts[M.verts.length-1].y=i):E.code===42?M.verts.length&&(M.verts[M.verts.length-1].bulge=i):E.code===70&&(M.data.flags=parseInt(E.value,10));break;case"ELLIPSE":E.code===10?M.data.cx=i:E.code===20?M.data.cy=i:E.code===11?M.data.mx=i:E.code===21?M.data.my=i:E.code===40?M.data.ratio=i:E.code===41?M.data.t1=i:E.code===42&&(M.data.t2=i);break;case"SPLINE":if(E.code===70)M.data.flags=parseInt(E.value,10);else if(E.code===71)M.data.degree=parseInt(E.value,10);else if(E.code===73)M.data.nCtrl=parseInt(E.value,10);else if(E.code===74)M.data.nFit=parseInt(E.value,10);else if(E.code===40)M.data.knots||(M.data.knots=[]),M.data.knots.push(i);else if(E.code===41)M.data.weights||(M.data.weights=[]),M.data.weights.push(i);else if(E.code===10)M.data.ctrlPts||(M.data.ctrlPts=[]),M.data.ctrlPts.push({x:i});else if(E.code===20){const c=M.data.ctrlPts;c&&c.length&&(c[c.length-1].y=i)}else if(E.code===11)M.data.fitPts||(M.data.fitPts=[]),M.data.fitPts.push({x:i});else if(E.code===21){const c=M.data.fitPts;c&&c.length&&(c[c.length-1].y=i)}break;case"POINT":E.code===10?M.data.x=i:E.code===20&&(M.data.y=i);break;case"TEXT":E.code===10?M.data.x=i:E.code===20?M.data.y=i:E.code===40?M.data.h=i:E.code===1&&(M.data.value=E.value||"");break;case"MTEXT":E.code===10?M.data.x=i:E.code===20?M.data.y=i:E.code===40?M.data.h=i:E.code===1&&(M.data.value=E.value||"");break;case"DIMENSION":E.code===10?M.data.x=i:E.code===20?M.data.y=i:E.code===70?M.data.flags=parseInt(E.value,10):E.code===1&&(M.data.value=E.value||"");break;case"LEADER":if(E.code===10)M.verts||(M.verts=[]),M.verts.push({x:i});else if(E.code===20){const c=M.verts||[];c.length&&(c[c.length-1].y=i)}break;case"HATCH":E.code===2?M.data.pattern=E.value||"":E.code===41&&(M.data.scale=i);break;case"INSERT":E.code===2?M.data.name=(E.value||"").trim():E.code===10?M.data.x=i:E.code===20?M.data.y=i:E.code===41?M.data.sx=i:E.code===42?M.data.sy=i:E.code===50?M.data.rot=i:E.code===70?M.data.rows=parseInt(E.value,10):E.code===71?M.data.cols=parseInt(E.value,10):E.code===44?M.data.colSpacing=i:E.code===45&&(M.data.rowSpacing=i);break}}M&&M!==gt&&(oe.has(M.type)?Tt.push(M):Tt.push({type:M.type,data:M.data||{},unsupported:!0}));const Pt=[];let me=0;const ke=[],Ut=new Set,Ne=[],Be=[];let ze=!1;const Zt=i=>{i&&i.type&&isFinite(i.len)&&i.len>=0&&(i.id=Pt.length,Pt.push(i),me+=i.len)};function ge(...i){return i.every(c=>Number.isFinite(c)&&!Number.isNaN(c))}function ft(i,c){Ne.push(c),Be.push({code:i,message:c}),i==="DXF_UNSUPPORTED_ENTITY"&&(ze=!0)}function je(i,c,y){var Yt,Ce;const w=i.data.name||"",g=wt.map.get(w);if(!g)return ft("DXF_MISSING_BLOCK",`INSERT references missing block: ${w}`),[];const F=y instanceof Set?y:new Set;if(F.has(w))return ft("DXF_BLOCK_CYCLE",`Block cycle detected: ${[...F,w].join(" -> ")}`),[];const O=new Set(F);O.add(w);const X=Math.max(1,Number.isFinite(i.data.rows)?i.data.rows:1),N=Math.max(1,Number.isFinite(i.data.cols)?i.data.cols:1),D=Number.isFinite(i.data.rowSpacing)?i.data.rowSpacing:0,I=Number.isFinite(i.data.colSpacing)?i.data.colSpacing:0,U=Number(i.data.x)||0,_=Number(i.data.y)||0,B=Number.isFinite(i.data.sx)?i.data.sx:1,q=Number.isFinite(i.data.sy)?i.data.sy:B,et=(Number.isFinite(i.data.rot)?i.data.rot:0)*Math.PI/180,bt=Math.abs(B-q)>1e-9,lt=Math.cos(et),it=Math.sin(et),at=lt*B,mt=it*B,tt=-it*q,R=lt*q,$=Math.max(Math.hypot(at,mt),Math.hypot(tt,R)),S=Math.max(1e-6,o/($||1)),A=Number((Yt=g.basePoint)==null?void 0:Yt.x)||0,H=Number((Ce=g.basePoint)==null?void 0:Ce.y)||0,z=Y=>{const j=(Y||"").trim();return!j||j==="0"?i.data.layer||void 0:j};function W(Y,j,K){const Ct=Y.x-A,st=Y.y-H,rt=Ct*lt-st*it,V=Ct*it+st*lt,Mt=j+rt*B,Nt=K+V*q;return{x:Mt,y:Nt}}c&&c.tx;const G=[];function J(Y,j,K){G.push({type:"POLY",data:{layer:K},verts:[],raw:{pts:Y,closed:j}})}function Ft(Y,j,K){const Ct=Y.type;if(Ct==="LINE"){const st=(c?V=>c.tx(W(V,j,K)):V=>W(V,j,K))({x:Y.data.x1||0,y:Y.data.y1||0}),rt=(c?V=>c.tx(W(V,j,K)):V=>W(V,j,K))({x:Y.data.x2||0,y:Y.data.y2||0});G.push({type:"LINE",data:{x1:st.x,y1:st.y,x2:rt.x,y2:rt.y,layer:z(Y.data.layer)}})}else if(Ct==="CIRCLE")if(bt){const st=Y.data.cx||0,rt=Y.data.cy||0,V=Y.data.r||0,Mt=Math.max(Math.abs(B*V),Math.abs(q*V)),Nt=Oe(Mt,S,2*Math.PI),Bt=[];for(let dt=0;dt<Nt;dt++){const At=2*Math.PI*dt/Nt,te={x:st+V*Math.cos(At),y:rt+V*Math.sin(At)},ee=(c?Rt=>c.tx(W(Rt,j,K)):Rt=>W(Rt,j,K))(te);Bt.push(ee)}J(Bt,!0,z(Y.data.layer));const St=(c?dt=>c.tx(W(dt,j,K)):dt=>W(dt,j,K))({x:st,y:rt});yt.push({kind:"circle",cx:St.x,cy:St.y,rx:Math.abs(V*B),ry:Math.abs(V*q),rotation:i.data.rot||0,closed:!0,layer:z(Y.data.layer)})}else{const st=(c?V=>c.tx(W(V,j,K)):V=>W(V,j,K))({x:Y.data.cx||0,y:Y.data.cy||0}),rt=Math.hypot(at,mt);G.push({type:"CIRCLE",data:{cx:st.x,cy:st.y,r:Math.abs(Y.data.r||0)*rt,layer:z(Y.data.layer)}})}else if(Ct==="ARC"){const st=Y.data.cx||0,rt=Y.data.cy||0,V=Y.data.r||0,Mt=(Y.data.a1||0)*Math.PI/180,Nt=(Y.data.a2||0)*Math.PI/180;if(bt){const Bt=Nt>=Mt?Nt-Mt:Nt+2*Math.PI-Mt,St=Math.max(Math.abs(B*V),Math.abs(q*V)),dt=Oe(St,S,Bt),At=[];for(let Rt=0;Rt<=dt;Rt++){const re=Mt+Bt*(Rt/dt),ce=(c?xe=>c.tx(W(xe,j,K)):xe=>W(xe,j,K))({x:st+V*Math.cos(re),y:rt+V*Math.sin(re)});At.push(ce)}J(At,!1,z(Y.data.layer));const te=(c?Rt=>c.tx(W(Rt,j,K)):Rt=>W(Rt,j,K))({x:st,y:rt}),ee=i.data.rot||0;yt.push({kind:"arc",cx:te.x,cy:te.y,rx:Math.abs(V*B),ry:Math.abs(V*q),rotation:ee,a1deg:(Y.data.a1||0)+ee,a2deg:(Y.data.a2||0)+ee,closed:!1,layer:z(Y.data.layer)})}else{const Bt=(c?dt=>c.tx(W(dt,j,K)):dt=>W(dt,j,K))({x:st,y:rt}),St=Math.hypot(at,mt);G.push({type:"ARC",data:{cx:Bt.x,cy:Bt.y,r:Math.abs(V)*St,a1:(Y.data.a1||0)+(i.data.rot||0),a2:(Y.data.a2||0)+(i.data.rot||0),layer:z(Y.data.layer)}})}}else if(Ct==="POINT"){const st=(c?rt=>c.tx(W(rt,j,K)):rt=>W(rt,j,K))({x:Y.data.x||0,y:Y.data.y||0});G.push({type:"POINT",data:{x:st.x,y:st.y,layer:z(Y.data.layer)}})}else if(Ct==="LWPOLYLINE"||Ct==="POLYLINE"){const st=[],rt=Y.verts||[];for(let V=0;V<rt.length-1;V++){const Mt=rt[V],Nt=rt[V+1];if(!(Number.isFinite(Mt.bulge)&&Math.abs(Mt.bulge)>1e-9)||!bt){const St=(c?dt=>c.tx(W(dt,j,K)):dt=>W(dt,j,K))({x:Mt.x||0,y:Mt.y||0});if(st.push(St),V===rt.length-2){const dt=(c?At=>c.tx(W(At,j,K)):At=>W(At,j,K))({x:Nt.x||0,y:Nt.y||0});st.push(dt)}}else{const St=Mt.x||0,dt=Mt.y||0,At=Nt.x||0,te=Nt.y||0,ee=Mt.bulge,Rt=Math.hypot(At-St,te-dt),re=4*Math.atan(ee),ce=Math.abs(Rt/(2*Math.sin(re/2))),xe=(St+At)/2,On=(dt+te)/2,tn=-(te-dt),en=At-St,nn=ce*Math.cos(re/2),an=ee>=0?1:-1,sn=Math.hypot(tn,en)||1,on=xe+an*(tn/sn)*nn,rn=On+an*(en/sn)*nn;let Xn=Math.atan2(dt-rn,St-on);const Dn=Math.max(Math.abs(B*ce),Math.abs(q*ce)),Yn=Math.abs(re),cn=Oe(Dn,S,Yn);for(let be=0;be<cn;be++){const de=Xn+re*(be/cn),Hn={x:on+ce*Math.cos(de),y:rn+ce*Math.sin(de)},Wn=(c?_e=>c.tx(W(_e,j,K)):_e=>W(_e,j,K))(Hn);st.push(Wn)}if(V===rt.length-2){const be=(c?de=>c.tx(W(de,j,K)):de=>W(de,j,K))({x:Nt.x||0,y:Nt.y||0});st.push(be)}}}J(st,!!(Y.data.flags&1),z(Y.data.layer))}else if(Ct==="INSERT"){const st={data:{name:Y.data.name,x:Y.data.x,y:Y.data.y,sx:Y.data.sx,sy:Y.data.sy,rot:Y.data.rot,rows:Y.data.rows,cols:Y.data.cols,rowSpacing:Y.data.rowSpacing,colSpacing:Y.data.colSpacing,layer:z(Y.data.layer)}},rt=je(st,{tx:V=>c?c.tx(W(V,j,K)):W(V,j,K)},O);for(const V of rt)G.push(V)}}for(let Y=0;Y<X;Y++)for(let j=0;j<N;j++){const K=j*I,Ct=Y*D,st=at*K+tt*Ct,rt=mt*K+R*Ct,V=U+st,Mt=_+rt;for(const Nt of g.ents||[])Ft(Nt,V,Mt)}return G}function Ie(i){var c,y,w,g,F,O,X,N,D,I,U,_,B,q,et,bt,lt,it,at,mt,tt;if(!i||!i.type){ft("DXF_ENTITY_NO_TYPE","Entity missing type information");return}if(i.type==="TEXT"){const R=Number((c=i.data)==null?void 0:c.x),$=Number((y=i.data)==null?void 0:y.y),S=Number((w=i.data)==null?void 0:w.h),A=String(((g=i.data)==null?void 0:g.value)||""),H=(F=i.data)==null?void 0:F.layer;Number.isFinite(R)&&Number.isFinite($)&&Lt.push({x:R*T,y:$*T,height:Number.isFinite(S)?S*T:void 0,value:A,layer:H});return}if(i.type==="MTEXT"){const R=Number((O=i.data)==null?void 0:O.x),$=Number((X=i.data)==null?void 0:X.y),S=Number((N=i.data)==null?void 0:N.h),A=String(((D=i.data)==null?void 0:D.value)||""),H=(I=i.data)==null?void 0:I.layer;Number.isFinite(R)&&Number.isFinite($)&&It.push({x:R*T,y:$*T,height:Number.isFinite(S)?S*T:void 0,value:A,layer:H}),ft("DXF_UNSUPPORTED_ENTITY",`Unsupported entity type: ${i.type}`);return}if(i.type==="DIMENSION"){const R=Number((U=i.data)==null?void 0:U.x),$=Number((_=i.data)==null?void 0:_.y),S=(B=i.data)==null?void 0:B.value,A=(q=i.data)==null?void 0:q.flags,H=(et=i.data)==null?void 0:et.layer;Number.isFinite(R)&&Number.isFinite($)&&Jt.push({x:R*T,y:$*T,value:S?String(S):void 0,flags:A,layer:H}),ft("DXF_UNSUPPORTED_ENTITY",`Unsupported entity type: ${i.type}`);return}if(i.type==="LEADER"){const R=(bt=i.data)==null?void 0:bt.layer,$=(i.verts||[]).filter(S=>Number.isFinite(S.x)&&Number.isFinite(S.y)).map(S=>({x:S.x*T,y:S.y*T}));Kt.push({points:$,layer:R}),ft("DXF_UNSUPPORTED_ENTITY",`Unsupported entity type: ${i.type}`);return}if(i.type==="HATCH"){const R=(lt=i.data)==null?void 0:lt.layer,$=(it=i.data)==null?void 0:it.pattern,S=(at=i.data)==null?void 0:at.scale;Qt.push({layer:R,pattern:$,scale:S});return}if(i.type==="LINE"){const{x1:R,y1:$,x2:S,y2:A}=i.data;if(!ge(R,$,S,A)){ft("DXF_BAD_LINE_PARAMS",`LINE entity has invalid coordinates: (${R},${$}) to (${S},${A})`);return}const H=R*T,z=$*T,W=S*T,G=A*T,J=Math.hypot(W-H,G-z)/1e3;if(J<=0){Ne.push("LINE entity has zero length");return}Zt({type:"LINE",len:J,start:[H,z],layer:i.data.layer,raw:{x1:H,y1:z,x2:W,y2:G}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="CIRCLE"){const{cx:R=0,cy:$=0,r:S=0}=i.data;if(!ge(R,$,S)||S<=0){ft("DXF_BAD_CIRCLE_PARAMS",`CIRCLE entity has invalid parameters: center(${R},${$}) radius=${S}`);return}const A=R*T,H=$*T,z=S*T;Zt({type:"CIRCLE",len:2*Math.PI*z/1e3,start:[A,H],layer:i.data.layer,raw:{cx:A,cy:H,r:z}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="ARC"){const{cx:R=0,cy:$=0,r:S=0,a1:A=0,a2:H=0}=i.data;if(!ge(R,$,S,A,H)||S<=0){ft("DXF_BAD_ARC_PARAMS",`ARC entity has invalid parameters: center(${R},${$}) radius=${S} angles(${A},${H})`);return}let z=A*Math.PI/180,G=H*Math.PI/180-z;if(G<0&&(G+=2*Math.PI),G<=0){ft("DXF_BAD_ARC_ANGLE",`ARC entity has invalid angle range: ${A}° to ${H}°`);return}const J=R*T,Ft=$*T,Yt=S*T;Zt({type:"ARC",len:Yt*G/1e3,start:[J+Yt*Math.cos(z),Ft+Yt*Math.sin(z)],layer:i.data.layer,raw:{cx:J,cy:Ft,r:Yt,a1:A,a2:H}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="LWPOLYLINE"||i.type==="POLYLINE"){let S=function(J,Ft,Yt){const Ce=Ft.x-J.x,Y=Ft.y-J.y,j=Math.hypot(Ce,Y),K=Number(Yt)||0;if(!K)return j;const Ct=4*Math.atan(K),st=Math.sin(Ct/2),rt=st===0?j/2:j/2/Math.abs(st);return Math.abs(rt*Ct)};const R=(i.verts||[]).filter(J=>Number.isFinite(J.x)&&Number.isFinite(J.y));if(R.length<2){ft("DXF_BAD_POLY_POINTS",`${i.type} entity has insufficient valid points: ${R.length}`);return}const $=R.map(J=>({x:J.x*T,y:J.y*T,bulge:Number.isFinite(J.bulge)?J.bulge:0}));let A=0;for(let J=0;J<$.length-1;J++)A+=S($[J],$[J+1],$[J].bulge);const H=$[0],z=$[$.length-1],W=!!(i.data.flags&1)||$.length>2&&Math.hypot(H.x-z.x,H.y-z.y)<=s;if(W&&(A+=S(z,H,z.bulge)),A<=0){Ne.push(`${i.type} entity has zero total length`);return}const G=$.map(J=>({x:J.x,y:J.y}));Zt({type:"POLY",len:A/1e3,start:[H.x,H.y],layer:i.data.layer,raw:{pts:G,closed:W}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="ELLIPSE"){const{cx:R=0,cy:$=0,mx:S=0,my:A=0,ratio:H=1,t1:z=0,t2:W=2*Math.PI}=i.data;if(!ge(R,$,S,A,H)){ft("DXF_BAD_ELLIPSE_PARAMS","ELLIPSE entity has invalid parameters");return}if(!(Math.hypot(S,A)>0)||!(H>0)){ft("DXF_BAD_ELLIPSE_PARAMS",`ELLIPSE invalid major axis or axis ratio: |(mx,my)|=${Math.hypot(S,A)}, ratio=${H}`);return}const G=p({cx:R,cy:$,mx:S,my:A,ratio:H,startParam:z,endParam:W});if(G.pts.length<2||G.lenM<=0){ft("DXF_ELLIPSE_APPROX_FAILED","ELLIPSE approximation failed");return}Zt({type:"POLY",len:G.lenM,start:[G.pts[0].x,G.pts[0].y],layer:i.data.layer,raw:{pts:G.pts,closed:G.closed}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="SPLINE"){const R=Number(i.data.degree);Number.isFinite(R)||ft("DXF_BAD_SPLINE_PARAMS","SPLINE degree is not a finite number");const $=Array.isArray(i.data.ctrlPts)?i.data.ctrlPts:[],S=Array.isArray(i.data.knots)?i.data.knots:[],A=Array.isArray(i.data.weights)?i.data.weights:void 0;if($.length<Math.max(2,Math.floor(R)+1)&&ft("DXF_BAD_SPLINE_PARAMS",`Insufficient control points: ${$.length} for degree=${R}`),S.length){for(let z=1;z<S.length;z++)if(!(S[z]>=S[z-1])){ft("DXF_BAD_SPLINE_PARAMS",`Non-monotonic knot vector at index ${z}`);break}}A&&A.length>0&&A.length!==$.length&&ft("DXF_BAD_SPLINE_PARAMS",`Weights length (${A.length}) does not match control points (${$.length})`);const H=h({degree:i.data.degree,ctrlPts:i.data.ctrlPts,fitPts:i.data.fitPts,knots:i.data.knots,flags:i.data.flags||0,weights:i.data.weights});if(H.pts.length<2||H.lenM<=0){ft("DXF_SPLINE_APPROX_FAILED","SPLINE approximation failed");return}Zt({type:"POLY",len:H.lenM,start:[H.pts[0].x,H.pts[0].y],layer:i.data.layer,raw:{pts:H.pts,closed:H.closed}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="POINT"){const R=i.data.x,$=i.data.y;if(!ge(R,$)){ft("DXF_BAD_POINT_PARAMS","POINT entity has invalid coordinates");return}const S=R*T,A=$*T;Zt({type:"POINT",len:0,start:[S,A],layer:i.data.layer,raw:{x:S,y:A}}),i.data.layer&&Ut.add(i.data.layer)}else if(i.type==="POLY"&&i.raw&&Array.isArray(i.raw.pts)){const R=i.raw.pts;if(R.length<2){ft("DXF_BAD_POLY_POINTS","POLY has insufficient points");return}let $=0;for(let S=0;S<R.length-1;S++)$+=Math.hypot(R[S+1].x-R[S].x,R[S+1].y-R[S].y);i.raw.closed&&($+=Math.hypot(R[0].x-R[R.length-1].x,R[0].y-R[R.length-1].y)),Zt({type:"POLY",len:$/1e3,start:[R[0].x,R[0].y],layer:(mt=i.data)==null?void 0:mt.layer,raw:{pts:R,closed:!!i.raw.closed}}),(tt=i.data)!=null&&tt.layer&&Ut.add(i.data.layer)}else ft("DXF_UNSUPPORTED_ENTITY",`Unsupported entity type: ${i.type}`)}for(const i of Tt){if(!i||!i.type){ft("DXF_ENTITY_NO_TYPE","Entity missing type information");continue}if(i.type==="INSERT"){const c=je(i);if(c&&c.length)for(const y of c)Ie(y);else{const y=wt.map.get(i.data&&i.data.name||"");if(y&&Array.isArray(y.ents)&&y.ents.length)for(const w of y.ents)Ie(w)}continue}Ie(i)}function Ve(i){if(!i)return[];if(i.type==="LINE"){const c=i.raw;return[{x:c.x1,y:c.y1},{x:c.x2,y:c.y2}]}if(i.type==="ARC"){const c=i.raw,y=c.cx||0,w=c.cy||0,g=c.r||0;let F=(c.a1||0)*Math.PI/180,O=(c.a2||0)*Math.PI/180;return O<F&&(O+=2*Math.PI),[{x:y+g*Math.cos(F),y:w+g*Math.sin(F)},{x:y+g*Math.cos(O),y:w+g*Math.sin(O)}]}if(i.type==="POLY"){const c=i.raw.pts||[];return c.length?i.raw.closed?[]:[{x:c[0].x,y:c[0].y},{x:c[c.length-1].x,y:c[c.length-1].y}]:[]}return[]}function Ln(i){if(i.type==="CIRCLE"){const c=i.raw;return[{x:c.cx+c.r,y:c.cy}]}if(i.type==="POLY"&&i.raw.closed){const c=i.raw.pts||[];if(c.length)return[{x:c[0].x,y:c[0].y}]}return Ve(i)}const ye=new Array(Pt.length).fill(!1);let Ge=0;ke.length=0;const Je=s,Ke=[];for(let i=0;i<Pt.length;i++){const c=Pt[i];if(!c||c.type==="CIRCLE"||c.type==="POLY"&&c.raw&&c.raw.closed)continue;const y=Ve(c);for(const w of y)Ke.push({x:w.x,y:w.y,ent:i})}const Xt=[];function Fn(i){let c=-1,y=1/0;for(let w=0;w<Xt.length;w++){const g=Xt[w],F=Math.hypot(i.x-g.x,i.y-g.y);F<=Je&&F<y&&(y=F,c=w)}if(c<0)return Xt.push({x:i.x,y:i.y,count:1,ents:new Set([i.ent])}),Xt.length-1;{const w=Xt[c];return w.x=(w.x*w.count+i.x)/(w.count+1),w.y=(w.y*w.count+i.y)/(w.count+1),w.count+=1,w.ents.add(i.ent),c}}const Se=new Map;for(const i of Ke){const c=Fn(i);let y=Se.get(i.ent);y||(y=[],Se.set(i.ent,y)),y.push(c)}const Ae=Array.from({length:Pt.length},()=>new Set);for(let i=0;i<Xt.length;i++){const c=Array.from(Xt[i].ents);for(let y=0;y<c.length;y++)for(let w=y+1;w<c.length;w++)Ae[c[y]].add(c[w]),Ae[c[w]].add(c[y])}function Tn(i,c){const y=i.length;if(y===0||y%2===1)return!1;const w=new Array(y).fill(!1);function g(){let F=0;for(;F<y&&w[F];)F++;if(F>=y)return!0;w[F]=!0;for(let O=F+1;O<y;O++){if(w[O])continue;const X=i[F],N=i[O];if(Math.hypot(X.x-N.x,X.y-N.y)<=c+1e-9){if(w[O]=!0,g())return!0;w[O]=!1}}return w[F]=!1,!1}return g()}for(let i=0;i<Pt.length;i++){if(ye[i])continue;if(!Pt[i]){ye[i]=!0;continue}const y=[],w=[i];for(ye[i]=!0;w.length;){const N=w.shift();y.push(N);const D=Pt[N];if(D&&!(D.type==="CIRCLE"||D.type==="POLY"&&D.raw&&D.raw.closed))for(const I of Ae[N])ye[I]||(ye[I]=!0,w.push(I))}let g=!1,F=!1,O=!1;for(const N of y){const D=Pt[N];D&&(D.type==="CIRCLE"?g=!0:D.type==="POLY"&&D.raw&&D.raw.closed?F=!0:O=!0)}let X=!1;if(g||F)X=!0;else if(O){const N=new Map,D=new Set;for(const q of y){const et=Pt[q];if(!et||et.type==="CIRCLE"||et.type==="POLY"&&et.raw&&et.raw.closed)continue;const bt=Se.get(q)||[];for(const lt of bt)D.add(lt),N.set(lt,(N.get(lt)||0)+1)}const I=[];for(const q of D)(N.get(q)||0)<=1&&I.push(q);const U=Je;let _=!1;if(I.length===2){const q=Xt[I[0]],et=Xt[I[1]];q&&et&&(_=Math.hypot(q.x-et.x,q.y-et.y)<=U+1e-9)}let B=!1;if(I.length>2){const q=I.map(et=>({x:Xt[et].x,y:Xt[et].y})).filter(Boolean);B=q.length===I.length&&Tn(q,U)}X=!I.length&&D.size>0||_||B}if(X){const N=[];for(const D of y){const I=Pt[D],U=Ln(I);for(const _ of U)N.push(_)}if(N.length){N.sort((I,U)=>I.x===U.x?I.y-U.y:I.x-U.x);const D=N[0];ke.push([D.x,D.y])}Ge++}}const qt=[];function kn(i){let c=0;for(let y=0;y<i.length;y++){const w=i[y],g=i[(y+1)%i.length];c+=w.x*g.y-g.x*w.y}return .5*c}function Re(i){if(i.type==="LINE"){const{x1:c,y1:y,x2:w,y2:g}=i.raw;return{minX:Math.min(c,w),minY:Math.min(y,g),maxX:Math.max(c,w),maxY:Math.max(y,g)}}if(i.type==="CIRCLE"){const{cx:c,cy:y,r:w}=i.raw;return{minX:c-w,minY:y-w,maxX:c+w,maxY:y+w}}if(i.type==="ARC"){const{cx:c,cy:y,r:w}=i.raw;return{minX:c-w,minY:y-w,maxX:c+w,maxY:y+w}}if(i.type==="POLY"){const c=i.raw.pts||[];let y=1/0,w=1/0,g=-1/0,F=-1/0;for(const O of c)y=Math.min(y,O.x),w=Math.min(w,O.y),g=Math.max(g,O.x),F=Math.max(F,O.y);return{minX:y,minY:w,maxX:g,maxY:F}}if(i.type==="POINT"){const{x:c,y}=i.raw;return{minX:c,minY:y,maxX:c,maxY:y}}return{minX:0,minY:0,maxX:0,maxY:0}}function Qe(i,c,y){let w=!1;for(let g=0,F=i.length-1;g<i.length;F=g++){const O=i[g].x,X=i[g].y,N=i[F].x,D=i[F].y;X>y!=D>y&&c<(N-O)*(y-X)/(D-X+1e-9)+O&&(w=!w)}return w}function In(i,c){if(i.bbox.minX>c.bbox.minX||i.bbox.maxX<c.bbox.maxX||i.bbox.minY>c.bbox.minY||i.bbox.maxY<c.bbox.maxY)return!1;const y=c.rep;if(i.kind==="poly")return c.kind==="circle"?Qe(i.pts,c.cx,c.cy):Qe(i.pts,y.x,y.y);{const w=(c.kind==="circle"?c.cx:y.x)-i.cx,g=(c.kind==="circle"?c.cy:y.y)-i.cy,F=Math.hypot(w,g);return c.kind==="circle"?F+c.r<=i.r+1e-6:F<=i.r+1e-6}}for(const i of Pt)if(i.type==="CIRCLE"){const{cx:c,cy:y,r:w}=i.raw;qt.push({id:i.id,ent:i,kind:"circle",area:Math.PI*w*w,depth:0,bbox:Re(i),rep:{x:c,y},cx:c,cy:y,r:w})}else if(i.type==="POLY"&&i.raw.closed){const c=i.raw.pts,y=kn(c),w=c[0];qt.push({id:i.id,ent:i,kind:"poly",area:Math.abs(y),signedArea:y,depth:0,bbox:Re(i),rep:w,pts:c})}for(let i=0;i<qt.length;i++){let c=0;for(let y=0;y<qt.length;y++)i!==y&&In(qt[y],qt[i])&&c++;qt[i].depth=c}const Sn=qt.slice().sort((i,c)=>c.depth-i.depth||i.area-c.area).map(i=>i.id);let Dt={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};for(const i of Pt){const c=Re(i);Dt.minX=Math.min(Dt.minX,c.minX),Dt.minY=Math.min(Dt.minY,c.minY),Dt.maxX=Math.max(Dt.maxX,c.maxX),Dt.maxY=Math.max(Dt.maxY,c.maxY)}isFinite(Dt.minX)||(Dt={minX:0,minY:0,maxX:0,maxY:0});let Ze=0;for(const i of qt){const c=i.depth%2===0?1:-1;Ze+=c*(i.area||0)}const An={units:"mm",insUnits:k,extMin:nt.minX!=null&&nt.minY!=null?{x:nt.minX*T,y:nt.minY*T}:void 0,extMax:nt.maxX!=null&&nt.maxY!=null?{x:nt.maxX*T,y:nt.maxY*T}:void 0},Rn=ht(r)||[],_n=Array.from(new Set([...Rn,...Ut]));if(l&&ze)throw new Error("DXF_STRICT_UNSUPPORTED: unsupported entities present");const $n=(wt.blocks||[]).map(i=>({name:i.name,basePoint:i.basePoint,ents:(i.ents||[]).map(c=>{var g,F,O,X,N,D,I,U,_,B,q,et,bt,lt,it,at,mt,tt,R,$,S,A,H,z,W,G,J;const y=c.type,w={type:y,layer:(g=c.data)==null?void 0:g.layer,colorIndex:(F=c.data)==null?void 0:F.colorIndex,linetype:(O=c.data)==null?void 0:O.linetype,lineweight:(X=c.data)==null?void 0:X.lineweight};return y==="LINE"?{...w,x1:(N=c.data)==null?void 0:N.x1,y1:(D=c.data)==null?void 0:D.y1,x2:(I=c.data)==null?void 0:I.x2,y2:(U=c.data)==null?void 0:U.y2}:y==="CIRCLE"?{...w,cx:(_=c.data)==null?void 0:_.cx,cy:(B=c.data)==null?void 0:B.cy,r:(q=c.data)==null?void 0:q.r}:y==="ARC"?{...w,cx:(et=c.data)==null?void 0:et.cx,cy:(bt=c.data)==null?void 0:bt.cy,r:(lt=c.data)==null?void 0:lt.r,a1:(it=c.data)==null?void 0:it.a1,a2:(at=c.data)==null?void 0:at.a2}:y==="LWPOLYLINE"||y==="POLYLINE"?{...w,points:(c.verts||[]).map(Ft=>({x:Ft.x,y:Ft.y,bulge:Ft.bulge})),flags:(mt=c.data)==null?void 0:mt.flags}:y==="INSERT"?{...w,name:(tt=c.data)==null?void 0:tt.name,x:(R=c.data)==null?void 0:R.x,y:($=c.data)==null?void 0:$.y,sx:(S=c.data)==null?void 0:S.sx,sy:(A=c.data)==null?void 0:A.sy,rot:(H=c.data)==null?void 0:H.rot,rows:(z=c.data)==null?void 0:z.rows,cols:(W=c.data)==null?void 0:W.cols,rowSpacing:(G=c.data)==null?void 0:G.rowSpacing,colSpacing:(J=c.data)==null?void 0:J.colSpacing}:w})}));return{entities:Pt,totalLen:me,lengthTotal:me,pierceCount:Ge,piercePts:ke,loops:qt,cutOrder:Sn,validationErrors:Ne,validationErrorsEx:Be,bbox:Dt,areaTotal:Ze,header:An,layers:_n,blocks:$n,texts:Lt,mtexts:It,dimensions:Jt,leaders:Kt,hatches:Qt,elliptics:yt}}function wn(t){if(!t)throw new Error("Парсинг вернул пусто");return t.entities=(t.entities||[]).filter(e=>e&&e.type&&e.raw),t.totalLen=Number(t.totalLen)||0,t.lengthTotal=Number(t.lengthTotal||t.totalLen)||0,t.pierceCount=Number(t.pierceCount)||0,t.piercePts=t.piercePts||[],t.loops=t.loops||[],t.cutOrder=t.cutOrder||[],t.bbox=t.bbox||{minX:0,minY:0,maxX:0,maxY:0},t.areaTotal=Number(t.areaTotal)||0,t.header=t.header||{units:"mm",insUnits:null},t.layers=t.layers||[],t.validationErrorsEx=t.validationErrorsEx||[],t.blocks=t.blocks||[],t.texts=t.texts||[],t.mtexts=t.mtexts||[],t.dimensions=t.dimensions||[],t.leaders=t.leaders||[],t.hatches=t.hatches||[],t.elliptics=t.elliptics||[],t}let Xe=null;function De(t){Xe||(Xe=requestAnimationFrame(()=>{t(),Xe=null}))}function fn(t,e,n){if(!e)throw new Error("Canvas элемент не найден");const a=e.getContext("2d");if(!a)throw new Error("Не удалось получить 2D контекст canvas");let o=!1;function s(){const h=e.getBoundingClientRect(),r=Math.max(1,Math.floor(h.width*vt)),f=Math.max(1,Math.floor(h.height*vt)),P=e.width!==r||e.height!==f;if(P&&(e.width=r,e.height=f),P)try{!t.hasUserTransform&&t.parsed&&t.parsed.entities&&t.parsed.entities.length>0&&Te(t,e),n()}catch(x){console.error("Ошибка в onDraw при изменении размера:",x)}}function l(){o||(o=!0,requestAnimationFrame(()=>{o=!1,s()}))}window.addEventListener("resize",l,{passive:!0}),s(),t.pan||(t.pan={x:0,y:0}),t.zoom||(t.zoom=1),typeof t.hasUserTransform!="boolean"&&(t.hasUserTransform=!1),t.tab||(t.tab="orig");const u=()=>{if(!e.width||!e.height){console.warn("Canvas имеет нулевые размеры");return}a.setTransform(t.zoom*vt,0,0,-t.zoom*vt,t.pan.x,e.height-t.pan.y)};t.__ctx=a,t.__world=u;let p=!1,m={x:0,y:0};e.addEventListener("mousedown",h=>{p=!0,m={x:h.clientX,y:h.clientY},t.__hover=null,hn()},{passive:!0}),window.addEventListener("mouseup",()=>p=!1,{passive:!0}),window.addEventListener("mousemove",h=>{if(p){const r=h.clientX-m.x,f=h.clientY-m.y;m={x:h.clientX,y:h.clientY},t.pan.x+=r,t.pan.y-=f,t.hasUserTransform=!0,De(n);return}if(t.index)try{const r=zn(t,e,h.clientX,h.clientY),f=ii(t,r.x,r.y,4/t.zoom),P=t.__hover&&t.__hover.id!==void 0?t.__hover.id:null,x=f&&f.id!==void 0?f.id:null;t.__hover=f,f?ni(h.clientX,h.clientY,ei(t,f)):hn(),P!==x&&De(n)}catch(r){console.warn("Ошибка при обработке hover:",r)}},{passive:!0}),e.addEventListener("wheel",h=>{if(!h||typeof h.deltaY!="number"||Math.abs(h.deltaY)<.01)return;h.preventDefault();const r=Math.exp(-h.deltaY*.0015);let f=Bn(t.zoom*r,.05,50);if(le(f,t.zoom,1e-9))return;const P=e.getBoundingClientRect(),x=(h.clientX-P.left)*vt,b=(h.clientY-P.top)*vt,v=(x-t.pan.x)/(t.zoom*vt),L=(e.height-b-t.pan.y)/(t.zoom*vt),k=v*f*vt+t.pan.x,T=e.height-(L*f*vt+t.pan.y);t.pan.x+=x-k,t.pan.y+=b-T,t.zoom=f,t.hasUserTransform=!0,De(n)},{passive:!1})}function ei(t,e){try{const n=t.parsed.entities[e.id];return n?`${n.type} • L=${(n.len||0).toFixed(3)} м`:""}catch(n){return console.warn("Ошибка при создании tooltip:",n),""}}function ni(t,e,n){try{const a=document.getElementById("tooltip");if(!a)return;a.innerHTML=n,a.style.display="block",a.style.left=t+"px",a.style.top=e+"px"}catch(a){console.warn("Ошибка при показе tooltip:",a)}}function hn(){try{const t=document.getElementById("tooltip");t&&(t.style.display="none")}catch(t){console.warn("Ошибка при скрытии tooltip:",t)}}function ii(t,e,n,a){if(!t.index)return null;try{for(const o of t.index)if(e>=o.minX-a&&e<=o.maxX+a&&n>=o.minY-a&&n<=o.maxY+a)return o;return null}catch(o){return console.warn("Ошибка при hit test:",o),null}}function pn(t,e,n=!1){if(!e||!e.getContext){console.error("Canvas не поддерживается");return}const a=e.getContext("2d");try{if(a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,e.width,e.height),!t.paths||t.paths.length===0)return;t.__world(),a.strokeStyle="#0066ff",a.lineWidth=.8/t.zoom,a.fillStyle="transparent";for(const o of t.paths)try{a.stroke(o)}catch(s){console.warn("Ошибка при рисовании пути:",s)}if(n&&t.piercePaths&&t.piercePaths.length>0){a.strokeStyle="#ff4444",a.fillStyle="rgba(255, 68, 68, 0.5)";for(const o of t.piercePaths)try{a.fill(o),a.stroke(o)}catch(s){console.warn("Ошибка при рисовании пути врезки:",s)}}if(t.__hover)try{const o=t.paths[t.__hover.id];o&&(a.strokeStyle="#ffcd3c",a.lineWidth=1/t.zoom,a.stroke(o))}catch(o){console.warn("Ошибка при подсветке hover:",o)}n&&ai(t,e,a)}catch(o){console.error("Ошибка при рисовании сущностей:",o),a.setTransform(1,0,0,1,0,0),a.fillStyle="#ff5c5c",a.font="14px system-ui",a.fillText("Ошибка отрисовки",18,28)}}function ai(t,e,n){if(t.parsed)try{t.parsed.piercePts&&t.parsed.piercePts.length>0&&si(t,e,n),t.showEntityNumbers&&t.parsed.entities&&t.parsed.entities.length<=50&&oi(t,e,n)}catch(a){console.warn("Ошибка при отображении аннотаций:",a)}}function si(t,e,n){var p;const a=t.parsed.piercePts,o=kt(),s=Number(((p=o==null?void 0:o.annotations)==null?void 0:p.maxPierceLabels)??0),l=Number.isFinite(s)&&s>0?Math.min(a.length,s):a.length,u=Math.max(8,12/t.zoom);n.font=`${u}px system-ui`,n.fillStyle="#ff8080",n.strokeStyle="#ffffff",n.lineWidth=2/t.zoom,n.textAlign="center",n.textBaseline="middle",n.save();for(let m=0;m<l;m++){const h=a[m];if(!(!h||!Array.isArray(h)||h.length<2))try{const r=`P${m+1}`;n.save(),n.translate(h[0],h[1]),n.scale(1,-1),n.strokeText(r,0,0),n.fillText(r,0,0),n.restore()}catch(r){console.warn("Ошибка при отображении метки врезки:",r)}}n.restore(),Number.isFinite(s)&&s>0&&a.length>s&&console.warn(`Ограничено количество меток врезок: ${s} из ${a.length}`)}function oi(t,e,n){const a=t.parsed.entities,o=Math.max(6,10/t.zoom);n.font=`${o}px system-ui`,n.fillStyle="#9db4ff",n.strokeStyle="#000000",n.lineWidth=1/t.zoom,n.textAlign="center",n.textBaseline="middle";for(let s=0;s<a.length;s++){const l=a[s];if(!(!l||!l.start))try{const u=`${s+1}`,p=l.start[0],m=l.start[1];n.save(),n.translate(p,m),n.scale(1,-1),n.strokeText(u,0,0),n.fillText(u,0,0),n.restore()}catch(u){console.warn("Ошибка при отображении номера объекта:",u)}}}function Te(t,e){if(!(!t.parsed||!t.parsed.entities||!e))try{const n=t.parsed.entities;if(n.length===0)return;let a=1/0,o=1/0,s=-1/0,l=-1/0;for(const b of n)if(!(!b||!b.raw))try{switch(b.type){case"LINE":{const{x1:v,y1:L,x2:k,y2:T}=b.raw;a=Math.min(a,v,k),o=Math.min(o,L,T),s=Math.max(s,v,k),l=Math.max(l,L,T);break}case"CIRCLE":{const{cx:v,cy:L,r:k}=b.raw;a=Math.min(a,v-k),o=Math.min(o,L-k),s=Math.max(s,v+k),l=Math.max(l,L+k);break}case"ARC":{const{cx:v,cy:L,r:k}=b.raw;a=Math.min(a,v-k),o=Math.min(o,L-k),s=Math.max(s,v+k),l=Math.max(l,L+k);break}case"POLY":{const v=b.raw.pts||[];for(const L of v)a=Math.min(a,L.x),o=Math.min(o,L.y),s=Math.max(s,L.x),l=Math.max(l,L.y);break}}}catch(v){console.warn("Ошибка при вычислении bounds для fitView:",v)}if(a===1/0)return;const u=s-a,p=l-o,m=Math.max(u,p)*.1,h=e.width/vt,r=e.height/vt,f=h/(u+2*m),P=r/(p+2*m),x=Math.min(f,P,50);t.zoom=x,t.pan.x=e.width/2-(a+u/2)*x*vt,t.pan.y=e.height/2-(o+p/2)*x*vt,t.hasUserTransform=!1}catch(n){console.error("Ошибка при fitView:",n)}}function ve(t){if(!t||!t.entities||!Array.isArray(t.entities))return{w:0,h:0,minX:0,minY:0};const e=ri(t.entities);return e.minX<1/0&&e.minY<1/0&&e.maxX>-1/0&&e.maxY>-1/0?{w:Math.max(0,e.maxX-e.minX),h:Math.max(0,e.maxY-e.minY),minX:e.minX,minY:e.minY}:{w:0,h:0,minX:0,minY:0}}function ri(t){let e=1/0,n=1/0,a=-1/0,o=-1/0;for(const s of t)if(!(!s||!s.raw))try{switch(s.type){case"LINE":{const{x1:l,y1:u,x2:p,y2:m}=s.raw;e=Math.min(e,l,p),n=Math.min(n,u,m),a=Math.max(a,l,p),o=Math.max(o,u,m);break}case"CIRCLE":{const{cx:l,cy:u,r:p}=s.raw;e=Math.min(e,l-p),n=Math.min(n,u-p),a=Math.max(a,l+p),o=Math.max(o,u+p);break}case"ARC":{const{cx:l,cy:u,r:p}=s.raw;e=Math.min(e,l-p),n=Math.min(n,u-p),a=Math.max(a,l+p),o=Math.max(o,u+p);break}case"POLY":{const l=s.raw.pts||[];for(const u of l)e=Math.min(e,u.x),n=Math.min(n,u.y),a=Math.max(a,u.x),o=Math.max(o,u.y);break}}}catch(l){console.warn("Ошибка при обработке сущности:",s,l)}return{minX:e,minY:n,maxX:a,maxY:o}}function ci(t,e,n,a,o,s,l){if(typeof t!="number"||!isFinite(t)||t<=0)return{cols:0,rows:0,placed:0,positions:[],workW:0,workH:0};if(typeof e!="number"||!isFinite(e)||e<=0)return{cols:0,rows:0,placed:0,positions:[],workW:0,workH:0};if((typeof n!="number"||!isFinite(n)||n<0)&&(n=0),(typeof a!="number"||!isFinite(a)||a<0)&&(a=0),typeof o!="number"||!isFinite(o)||o<=0)return{cols:0,rows:0,placed:0,positions:[],workW:0,workH:0};if(typeof s!="number"||!isFinite(s)||s<=0)return{cols:0,rows:0,placed:0,positions:[],workW:0,workH:0};(typeof l!="number"||!isFinite(l)||l<0)&&(l=0);const u=t-2*n,p=e-2*n;if(u<=0||p<=0)return{cols:0,rows:0,placed:0,positions:[],workW:u,workH:p};const m=Math.max(0,Math.floor((u+a)/(o+a))),h=Math.max(0,Math.floor((p+a)/(s+a))),r=m*h,f=Math.min(l,r),P=[];let x=0;for(let b=0;b<h&&x<f;b++)for(let v=0;v<m&&x<f;v++)P.push({x:n+v*(o+a),y:n+b*(s+a)}),x++;return{cols:m,rows:h,placed:f,positions:P,workW:u,workH:p}}function ue(t,e,n,a,o,s,l,u=[0,90]){(!Array.isArray(u)||u.length===0)&&(u=[0,90]);const p=[],m=Array.from(new Set(u.map(f=>(f%360+360)%360)));for(const f of m){const P=f===90||f===270?l:s,x=f===90||f===270?s:l,b=ci(t,e,n,a,P,x,o);p.push({...b,rot:f,pw:P,ph:x})}p.sort((f,P)=>P.placed!==f.placed?P.placed-f.placed:P.workW*P.workH-f.workW*f.workH);const h=p[0]||{cols:0,rows:0,placed:0,rot:0,pw:s,ph:l,positions:[],workW:0,workH:0},r=Math.max(1,Math.ceil(o/Math.max(h.placed,1)));return{...h,sheets:r,W:t,H:e,m:n,g:a,rotations:m}}function li(t,e){if(!e||!e.getContext){console.error("Canvas не поддерживается");return}const n=e.getContext("2d");n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,e.width,e.height);const a=t.nesting;if(!a){n.fillStyle="#7180a3",n.font="14px system-ui",n.fillText("Сначала рассчитайте раскладку",18,28);return}try{const o=30*(window.devicePixelRatio||1),s=Math.min((e.width-2*o)/a.W,(e.height-2*o)/a.H),l=(e.width-a.W*s)/2,u=(e.height-a.H*s)/2;n.fillStyle="#101828",n.strokeStyle="#2b3753",n.lineWidth=2,n.fillRect(l,u,a.W*s,a.H*s),n.strokeRect(l,u,a.W*s,a.H*s),n.setLineDash([8,8]),n.strokeStyle="#394b78",n.strokeRect(l+a.m*s,u+a.m*s,(a.W-2*a.m)*s,(a.H-2*a.m)*s),n.setLineDash([]),n.strokeStyle="#77a1ff",n.fillStyle="rgba(109,140,255,0.18)",n.lineWidth=2;const p=a.pw,m=a.ph;for(let h=0;h<a.positions.length;h++){const r=a.positions[h],f=l+r.x*s,P=u+r.y*s,x=p*s,b=m*s;if(n.fillRect(f,P,x,b),n.strokeRect(f,P,x,b),t&&t.showNestingLabels){const v="#ffffff",L=Math.max(10,Math.min(16,Math.floor(Math.min(x,b)/6))),k=Math.max(12,Math.floor(L*1.2)),T=f+x/2,Q=P+4,nt=Q+k,ht=t&&t.parsed&&Number.isFinite(t.parsed.pierceCount)?t.parsed.pierceCount:0,ut=t&&t.parsed&&Number.isFinite(t.parsed.totalLen)?t.parsed.totalLen:0;n.font=`${L}px system-ui`,n.textBaseline="top",n.textAlign="center",n.strokeStyle="rgba(0,0,0,0.55)",n.lineWidth=Math.max(2,Math.round(L/6)),n.strokeText(`Врезки: ${ht}`,T,Q),n.strokeText(`Рез: ${ut.toFixed(2)} м`,T,nt),n.fillStyle=v,n.fillText(`Врезки: ${ht}`,T,Q),n.fillText(`Рез: ${ut.toFixed(2)} м`,T,nt),n.fillStyle="rgba(109,140,255,0.18)"}}}catch(o){console.error("Ошибка при рисовании раскладки:",o),n.fillStyle="#ff5c5c",n.font="14px system-ui",n.fillText("Ошибка отрисовки",18,28)}}function ui(t){if(!t||!t.placed||!t.pw||!t.ph||!t.W||!t.H)return 0;const e=t.placed*(t.pw*t.ph),n=t.W*t.H;return n>0?e/n*100:0}function di({parseDXF:t,sanitizeParsed:e,computeNesting:n}){return async function(){const o=document.getElementById("testsCard");o&&(o.hidden=!1);const s=document.getElementById("testsOut");s&&(s.textContent="Выполняю…",s.innerHTML="");let l=0,u=0;const p=[{name:"LINE + CIRCLE",dxf:fi(),expect:r=>le(r.totalLen,.298501,.005)&&r.entities.length>=2},{name:"LWPOLYLINE (прямоугольник 100x50, замкнутый)",dxf:hi(),expect:r=>le(r.totalLen,.3,.005)&&r.entities.find(f=>f.type==="POLY")},{name:"ARC полукруг r=10",dxf:pi(),expect:r=>le(r.totalLen,.031416,.002)&&r.entities.find(f=>f.type==="ARC")},{name:"ARC 350→10 (20° дуга)",dxf:mi(),expect:r=>r.entities.find(f=>f.type==="ARC")&&le(r.totalLen,.003491,5e-4)},{name:"ARC 0→270 (3/4 окружности)",dxf:gi(),expect:r=>r.entities.find(f=>f.type==="ARC")&&le(r.totalLen,.047124,.001)},{name:"Пустой ENTITIES",dxf:yi(),expect:r=>r.entities.length===0&&r.pierceCount===0},{name:"lowercase section/entities/endsec + lowercase entities",dxf:xi(),expect:r=>r.entities.length===2&&le(r.totalLen,.298501,.005)}],m=[{name:"Корректные параметры резки (1.5кВт, 5мм, азот)",test:()=>{const r=zt(1.5,5,"nitrogen");return r.can===!0&&r.speed>0&&r.pierce>0}},{name:"Недопустимая толщина (1.5кВт, 20мм, азот)",test:()=>{const r=zt(1.5,20,"nitrogen");return r.can===!1&&r.reason.includes("Недостаточная мощность")}},{name:"Недопустимая мощность (5кВт, 5мм, азот)",test:()=>{const r=zt(5,5,"nitrogen");return r.can===!1&&r.reason.includes("Неподдерживаемая мощность")}},{name:"Недопустимый газ (1.5кВт, 5мм, helium)",test:()=>{const r=zt(1.5,5,"helium");return r.can===!1&&r.reason.includes("Неподдерживаемый тип газа")}},{name:"Отрицательная толщина (1.5кВт, -5мм, азот)",test:()=>{const r=zt(1.5,-5,"nitrogen");return r.can===!1&&r.reason.includes("Толщина должна быть положительным числом")}},{name:"Поддерживаемые мощности",test:()=>{const r=Kn();return Array.isArray(r)&&r.length>0&&r.includes(1.5)}},{name:"Поддерживаемые газы",test:()=>{const r=Qn();return Array.isArray(r)&&r.includes("nitrogen")&&r.includes("oxygen")}},{name:"Максимальная толщина",test:()=>{const r=Zn(1.5,"nitrogen");return typeof r=="number"&&r>0}}],h=[{name:"Нестинг 0° 60×40 / 35×20 → 2/лист",test:()=>ue(60,40,0,0,999,35,20,[0]).placed===2},{name:"Нестинг 0/90° 60×40 / 35×20 → 3/лист",test:()=>ue(60,40,0,0,999,35,20,[0,90]).placed===3},{name:"Нестинг с отступами и зазорами",test:()=>{const r=ue(100,100,10,5,10,20,15,[0]);return r.placed>0&&r.m===10&&r.g===5}},{name:"Bounding box для пустых данных",test:()=>{const r=ve({entities:[]});return r.w===0&&r.h===0}},{name:"Эффективность раскладки",test:()=>{const r=ue(100,100,0,0,1,50,50,[0]),f=ui(r);return typeof f=="number"&&f>=0&&f<=100}},{name:"Валидация входных параметров раскладки",test:()=>{const r=ue(-10,100,0,0,1,50,50,[0]),f=ue(100,-10,0,0,1,50,50,[0]);return r.placed===0&&f.placed===0}}];console.log("Запуск тестов парсера DXF...");for(let r=0;r<p.length;r++){const f=p[r];try{const P=e(await t(f.dxf)),x=!!f.expect(P);s&&(s.innerHTML+=`<div>${x?"✅":"❌"} ${f.name}</div>`),x?l++:u++}catch(P){s&&(s.innerHTML+=`<div>❌ ${f.name} (ошибка: ${P.message})</div>`),u++,console.error(`Ошибка в тесте "${f.name}":`,P)}}console.log("Запуск тестов расчётов стоимости...");for(let r=0;r<m.length;r++){const f=m[r];try{const P=f.test();s&&(s.innerHTML+=`<div>${P?"✅":"❌"} ${f.name}</div>`),P?l++:u++}catch(P){s&&(s.innerHTML+=`<div>❌ ${f.name} (ошибка: ${P.message})</div>`),u++,console.error(`Ошибка в тесте "${f.name}":`,P)}}console.log("Запуск тестов раскладки...");for(let r=0;r<h.length;r++){const f=h[r];try{const P=f.test();s&&(s.innerHTML+=`<div>${P?"✅":"❌"} ${f.name}</div>`),P?l++:u++}catch(P){s&&(s.innerHTML+=`<div>❌ ${f.name} (ошибка: ${P.message})</div>`),u++,console.error(`Ошибка в тесте "${f.name}":`,P)}}return s&&(s.innerHTML+=`<div style="margin-top: 10px; font-weight: bold;">
        Итог: <span class="test-pass">${l} PASS</span>, <span class="test-fail">${u} FAIL</span>
      </div>`),console.log(`Тесты завершены: ${l} успешно, ${u} неудачно`),{passed:l,failed:u,total:l+u}}}const fe=()=>`0
SECTION
2
ENTITIES
`,he=()=>`0
ENDSEC
0
EOF
`;function fi(){return fe()+`0
LINE
10
0
20
0
11
100
21
100
0
CIRCLE
10
50
20
50
40
25
`+he()}function hi(){return fe()+`0
LWPOLYLINE
70
1
10
0
20
0
10
100
20
0
10
100
20
50
10
0
20
50
`+he()}function pi(){return fe()+`0
ARC
10
0
20
0
40
10
50
0
51
180
`+he()}function mi(){return fe()+`0
ARC
10
0
20
0
40
10
50
350
51
10
`+he()}function gi(){return fe()+`0
ARC
10
0
20
0
40
10
50
0
51
270
`+he()}function yi(){return fe()+he()}function xi(){return`0
section
2
entities
0
line
10
0
20
0
11
100
21
100
0
circle
10
50
20
50
40
25
0
endsec
0
eof
`}class bi{constructor(){this.metrics=new Map,this.enabled=(typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.search.includes("debug=true")),!1)}startTimer(e){this.enabled&&this.metrics.set(e+"_start",performance.now())}endTimer(e){if(!this.enabled)return;const n=this.metrics.get(e+"_start");if(n){const a=performance.now()-n,o=this.metrics.get(e)||[];o.push(a),this.metrics.set(e,o),this.metrics.delete(e+"_start"),a>100&&console.warn(`Performance: ${e} took ${a.toFixed(2)}ms`)}}getAverageTime(e){const n=this.metrics.get(e)||[];return n.length===0?0:n.reduce((a,o)=>a+o,0)/n.length}getReport(){const e={};for(const[n,a]of this.metrics.entries())Array.isArray(a)&&(e[n]={count:a.length,average:this.getAverageTime(n),min:Math.min(...a),max:Math.max(...a)});return e}clear(){this.metrics.clear()}enable(){this.enabled=!0,console.log("Performance monitoring enabled")}disable(){this.enabled=!1}}const jt=new bi;function we(t,e){jt.startTimer(t);try{const n=e();return n instanceof Promise?n.finally(()=>jt.endTimer(t)):(jt.endTimer(t),n)}catch(n){throw jt.endTimer(t),n}}const Z={files:[],activeFileId:null,nextFileId:1},C={rawDXF:"",parsed:null,tab:"orig",pan:{x:0,y:0},zoom:1,nesting:null,paths:[],piercePaths:[],index:null,sheetIndex:0,showNestingLabels:!0};let Ht=null;function Pn(){var t,e,n,a,o,s;try{const l=parseFloat(((t=d("th"))==null?void 0:t.value)||((n=(e=kt())==null?void 0:e.cutting)==null?void 0:n.thickness)||"1"),u=Me(l),p=kt(),m=p!=null&&p.pricing&&Number.isFinite(p.pricing.markupPercent)?1+p.pricing.markupPercent/100:1;d("pPerM")&&(d("pPerM").value=u?u.cutPerMm*1e3*m:0),d("pPierce")&&(d("pPierce").value=u?u.pierce*m:0),d("machPrice")&&(d("machPrice").value=((a=p==null?void 0:p.pricing)==null?void 0:a.machineHourPrice)||0),console.log("Pricing (from config.json):",{th:l,tariff:u,mh:(s=(o=kt())==null?void 0:o.pricing)==null?void 0:s.machineHourPrice})}catch(l){console.warn("Failed to apply pricing fields from config:",l)}}function wi(){const t=Wt();if(!t||!t.parsed){ct("Нет активной детали для раскладки","err");return}const e=ve(t.parsed);if(!(e&&e.w>0&&e.h>0)){ct("У активной детали нулевой bbox","err");return}const n=+d("sW").value,a=+d("sH").value,o=+d("margin").value,s=+d("spacing").value,l=d("rotations").value;let u=[];try{u=(l||"").split(",").map(b=>parseInt(b.trim(),10)).filter(b=>Number.isFinite(b))}catch{}u.length||(u=[0,90]);const p=Math.max(0,n-2*o),m=Math.max(0,a-2*o),h=[],r=(b,v,L)=>{h.some(k=>Math.abs(k.w-b)<1e-9&&Math.abs(k.h-v)<1e-9)||h.push({w:b,h:v,rot:L})};for(const b of u)b===0||b===180?r(e.w,e.h,b):(b===90||b===270)&&r(e.h,e.w,b);h.length||h.push({w:e.w,h:e.h,rot:0});let f={cap:0,w:e.w,h:e.h};for(const b of h){const v=b.w+s,L=b.h+s,k=v>0?Math.floor((p+s)/v):0,T=L>0?Math.floor((m+s)/L):0,Q=Math.max(0,k)*Math.max(0,T);Q>f.cap&&(f={cap:Q,w:b.w,h:b.h,rot:b.rot,cols:k,rows:T})}const P=Math.max(1,f.cap);t.quantity=P,Z.files.forEach(b=>{b.includeInLayout=b.id===t.id});const x=d("qty");x&&(x.value=String(P)),document.querySelectorAll(".file-tab").forEach(b=>{const v=b.getAttribute("data-file-id"),L=b.querySelector(".quantity-input");L&&v===t.id&&(L.value=String(P));const k=b.querySelector('.file-tab-include input[type="checkbox"]');k&&(k.checked=v===t.id)}),ct(`Заполняем лист деталью: ${t.name} × ${P}`,"ok"),Et()}function $t(){try{const t=Ht||d("cv");if(!t)return;const e=C.tab||"orig";e==="nest"?C.combinedNesting?Pi(C,t):C.nesting?li(C,t):pn(C,t,!1):pn(C,t,e==="annot")}catch(t){console.warn("safeDraw failed:",t)}}function qe(t){var e,n;try{const a=document.querySelector(`.file-tab[data-file-id="${t.id}"]`);if(!a)return;const o=a.querySelector(".file-tab-stats");if(!o)return;const s=(e=t==null?void 0:t.parsed)==null?void 0:e.pierceCount,l=(n=t==null?void 0:t.parsed)==null?void 0:n.totalLen,u=t!=null&&t.parsed?ve(t.parsed):null,p=u&&Number.isFinite(u.w)?u.w:NaN,m=u&&Number.isFinite(u.h)?u.h:NaN,h=Number.isFinite(p)&&Number.isFinite(m)?p*m:NaN;if(Number.isFinite(s)&&Number.isFinite(l)){const r=Number.isFinite(p)?p.toFixed(0):"—",f=Number.isFinite(m)?m.toFixed(0):"—",P=Number.isFinite(h)?(Math.ceil(h/1e6*10)/10).toFixed(1):"—";o.innerHTML=`Врезки: ${s}<br>Рез: ${l.toFixed(2)} м<br>W: ${r} мм H: ${f} мм S: ${P} м²`}else o.innerHTML="Врезки: —<br>Рез: — м<br>W: — мм H: — мм S: — м²"}catch(a){console.warn("updateFileTabStats failed:",a)}}function Pi(t,e){var b,v;const n=e.getContext("2d");n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,e.width,e.height);const a=t.combinedNesting;if(!a||!Array.isArray(a.sheets)||a.sheets.length===0){n.fillStyle="#7180a3",n.font="14px system-ui",n.fillText("Нет данных раскладки",18,28);return}const o=+d("sW").value||1250,s=+d("sH").value||2500,l=+d("margin").value||0,u=Math.max(0,Math.min(t.sheetIndex||0,a.sheets.length-1)),p=a.sheets[u],m=30*(window.devicePixelRatio||1),h=Math.min((e.width-2*m)/o,(e.height-2*m)/s),r=(e.width-o*h)/2,f=(e.height-s*h)/2;n.fillStyle="#101828",n.strokeStyle="#2b3753",n.lineWidth=2,n.fillRect(r,f,o*h,s*h),n.strokeRect(r,f,o*h,s*h),n.setLineDash([8,8]),n.strokeStyle="#394b78",n.strokeRect(r+l*h,f+l*h,(o-2*l)*h,(s-2*l)*h),n.setLineDash([]);const P=new Map;try{((Z==null?void 0:Z.files)||[]).forEach(L=>P.set(L.id,L))}catch{}n.strokeStyle="#9db4ff",n.fillStyle="rgba(109,140,255,0.18)",n.lineWidth=2;const x=Array.isArray(p.parts)?p.parts:[];for(let L=0;L<x.length;L++){const k=x[L],T=r+(l+(k.x||0))*h,Q=f+(l+(k.y||0))*h,nt=(k.placedWidth||k.width||0)*h,ht=(k.placedHeight||k.height||0)*h;if(n.fillRect(T,Q,nt,ht),n.strokeRect(T,Q,nt,ht),t.showNestingLabels){const ut="#ffffff",pt=Math.max(10,Math.min(16,Math.floor(Math.min(nt,ht)/6))),_t=Math.max(12,Math.floor(pt*1.2)),wt=T+nt/2,Tt=_t+pt,E=Math.max(Q+2,Math.min(Q+ht-Tt-2,Q+(ht-Tt)/2)),M=E+_t;let gt=Number.isFinite((b=k==null?void 0:k.metrics)==null?void 0:b.pierceCount)?k.metrics.pierceCount:Number.isFinite(k==null?void 0:k.pierceCount)?k.pierceCount:NaN,Lt=Number.isFinite((v=k==null?void 0:k.metrics)==null?void 0:v.totalLen)?k.metrics.totalLen:Number.isFinite(k==null?void 0:k.totalLen)?k.totalLen:NaN;if(!Number.isFinite(gt)||!Number.isFinite(Lt)){const It=P.get(k.fileId);It&&It.parsed?(Number.isFinite(gt)||(gt=Number(It.parsed.pierceCount)||0),Number.isFinite(Lt)||(Lt=Number(It.parsed.totalLen)||0)):(Number.isFinite(gt)||(gt=0),Number.isFinite(Lt)||(Lt=0))}n.font=`${pt}px system-ui`,n.textBaseline="top",n.textAlign="center",n.strokeStyle="rgba(0,0,0,0.55)",n.lineWidth=Math.max(2,Math.round(pt/6)),n.strokeText(`Врезки: ${gt}`,wt,E),n.strokeText(`Рез: ${Lt.toFixed(2)} м`,wt,M),n.fillStyle=ut,n.fillText(`Врезки: ${gt}`,wt,E),n.fillText(`Рез: ${Lt.toFixed(2)} м`,wt,M),n.fillStyle="rgba(109,140,255,0.18)"}}}let Ye=null;function Mi(){var t,e,n;try{const a={power:(t=d("power"))==null?void 0:t.value,gas:(e=d("gas"))==null?void 0:e.value,thickness:d("th")?parseFloat(d("th").value):void 0,sheetWidth:d("sW")?parseInt(d("sW").value):void 0,sheetHeight:d("sH")?parseInt(d("sH").value):void 0,margin:d("margin")?parseInt(d("margin").value):void 0,spacing:d("spacing")?parseInt(d("spacing").value):void 0,rotations:(n=d("rotations"))==null?void 0:n.value,quantity:d("qty")?parseInt(d("qty").value):void 0};Gn(a)}catch(a){console.warn("saveCurrentConfig failed:",a)}}function mn(){var t,e,n,a,o,s,l,u,p;try{const m={thickness:d("th"),power:d("power"),gas:d("gas"),pricePerMeter:d("pPerM"),pricePerPierce:d("pPierce"),machineHourPrice:d("machPrice"),sheetWidth:d("sW"),sheetHeight:d("sH"),margin:d("margin"),spacing:d("spacing"),quantity:d("qty"),rotations:d("rotations")};Vn(m);try{const h=$e==null?void 0:$e();h&&typeof h=="object"&&(m.power&&((t=h.cutting)!=null&&t.power)&&(m.power.value=h.cutting.power),m.gas&&((e=h.cutting)!=null&&e.gas)&&(m.gas.value=h.cutting.gas),m.thickness&&((n=h.cutting)==null?void 0:n.thickness)!=null&&(m.thickness.value=Number(h.cutting.thickness)),m.sheetWidth&&((a=h.sheet)!=null&&a.width)&&(m.sheetWidth.value=h.sheet.width),m.sheetHeight&&((o=h.sheet)!=null&&o.height)&&(m.sheetHeight.value=h.sheet.height),m.margin&&((s=h.sheet)==null?void 0:s.margin)!=null&&(m.margin.value=h.sheet.margin),m.spacing&&((l=h.sheet)==null?void 0:l.spacing)!=null&&(m.spacing.value=h.sheet.spacing),m.quantity&&((u=h.sheet)==null?void 0:u.quantity)!=null&&(m.quantity.value=h.sheet.quantity),m.rotations&&((p=h.nesting)!=null&&p.rotations)&&(m.rotations.value=h.nesting.rotations))}catch(h){console.warn("apply saved config failed:",h)}Pn()}catch(m){console.warn("initConfigUI failed:",m)}}function ne(){try{Ye&&clearTimeout(Ye)}catch{}Ye=setTimeout(Mi,300)}function se(){try{const t=d("emptyLayoutMessage");if(!t)return;Z.files.some(n=>n&&n.parsed)?t.classList.remove("visible"):t.classList.add("visible")}catch(t){console.warn("updateEmptyLayoutMessage failed:",t)}}function He(){try{const t=document.getElementById("detailsHeader"),e=document.getElementById("detailsContent"),n=document.getElementById("detailsToggle");if(!t||!e||!n||t.dataset.bound==="1")return;const a=o=>{e.classList.toggle("expanded",!!o),n.classList.toggle("expanded",!!o),n.textContent=o?"▼":"▶",n.title=o?"Скрыть":"Показать",e.style.display=o?"block":"none"};a(e.classList.contains("expanded")),n.addEventListener("click",o=>{o.stopPropagation();const s=!e.classList.contains("expanded");a(s)}),t.addEventListener("click",o=>{if(o.target===n)return;const s=!e.classList.contains("expanded");a(s)}),t.dataset.bound="1"}catch(t){console.warn("setupDetailsToggle failed:",t)}}let ie=null;try{ie=new Worker(new URL("/assets/nesting-worker-BJGOkgzu.js",import.meta.url),{type:"module"}),ie.onerror=t=>console.error("[nesting worker error]",t.message)}catch(t){console.warn("Nesting worker init failed:",t),ie=null}function vi(t,e=1e4){return new Promise((n,a)=>{if(!ie)return a(new Error("no-nesting-worker"));let o=setTimeout(()=>{ie.removeEventListener("message",s),a(new Error("timeout"))},e);function s(l){clearTimeout(o),ie.removeEventListener("message",s),n(l.data)}ie.addEventListener("message",s),ie.postMessage(t)})}function Ni(t){var p,m,h,r,f,P;const e=+d("sW").value,n=+d("sH").value,a=+d("margin").value,o=+d("spacing").value,s=d("rotations").value;let l=[];try{l=(s||"").split(",").map(x=>parseInt(x.trim(),10)).filter(x=>Number.isFinite(x))}catch{}l.length||(l=[0,90]);const u=[];for(const x of t){const b=ve(x.parsed);if(b.w<=0||b.h<=0)continue;const v=x.quantity||1,L=((p=x.settings)==null?void 0:p.thickness)??parseFloat(((m=d("th"))==null?void 0:m.value)||"3"),k=((h=x.settings)==null?void 0:h.power)??(((r=d("power"))==null?void 0:r.value)||"1.5"),T=((f=x.settings)==null?void 0:f.gas)??(((P=d("gas"))==null?void 0:P.value)||"nitrogen"),Q=zt(k,L,T),nt=Me(L)||{cutPerMm:0,pierce:0,machineHourPrice:0,markupPercent:0};u.push({fileId:x.id,pw:b.w,ph:b.h,qty:v,settings:{thickness:L,power:k,gas:T},metrics:{totalLen:x.parsed.totalLen||0,pierceCount:x.parsed.pierceCount||0},tariff:nt,params:{speed:(Q==null?void 0:Q.speed)??0,pierce:(Q==null?void 0:Q.pierce)??0}})}return{sheet:{width:e,height:n,margin:a,spacing:o,rotations:l},parts:u}}async function Ci(t){const e=C.tab,n=Ni(t);ct("Вычисление раскладки...","warn");const a=await vi(n,2e4);if(!a||!a.ok)throw new Error((a==null?void 0:a.error)||"nesting-failed");C.combinedNesting=a.layout,C.nesting=null,C.sheetIndex=0;const o=Ei();Ue(C.combinedNesting,o),ct("Раскладка обновлена","ok"),se(),e==="nest"&&(C.tab="nest",document.querySelectorAll(".tab").forEach(s=>s.classList.toggle("active",s.dataset.tab==="nest"))),$t(),ae()}function Ei(){const t=Z.files.filter(n=>n.includeInLayout&&n.parsed),e=[];return t.forEach(n=>{const a=n.quantity||1;for(let o=0;o<a;o++)e.push({file:n})}),e}function Li(){var n,a,o;const t=[],e=Wt();if(e&&(e.tab!==C.tab&&t.push("Tab state desynchronized"),JSON.stringify(e.pan)!==JSON.stringify(C.pan)&&t.push("Pan state desynchronized"),e.zoom!==C.zoom&&t.push("Zoom state desynchronized")),Ot.lastParams&&C.parsed){const s=`${(n=d("th"))==null?void 0:n.value}-${(a=d("power"))==null?void 0:a.value}-${(o=d("gas"))==null?void 0:o.value}`;Ot.lastParams.includes(s)||(console.log("Config change detected, invalidating calculation cache"),Ot.lastParams=null,Ot.lastResult=null)}return t.length>0&&console.warn("State synchronization warnings:",t),t.length===0}function Fi(t,e){var n,a,o,s,l,u,p,m,h;return{id:`file_${Z.nextFileId++}`,name:t.name,originalName:t.name,rawDXF:e,parsed:null,paths:[],piercePaths:[],index:null,visible:!0,quantity:1,includeInLayout:!0,settings:{thickness:Number(((n=d("th"))==null?void 0:n.value)??((o=(a=kt())==null?void 0:a.cutting)==null?void 0:o.thickness)??3),power:String(((s=d("power"))==null?void 0:s.value)??((u=(l=kt())==null?void 0:l.cutting)==null?void 0:u.power)??"1.5"),gas:String(((p=d("gas"))==null?void 0:p.value)??((h=(m=kt())==null?void 0:m.cutting)==null?void 0:h.gas)??"nitrogen")},calculations:null,nesting:null,tab:"orig",pan:{x:0,y:0},zoom:1,hasUserTransform:!1}}function Ti(t){const e=d("fileTabs"),n=d("fileTabsList");if(!e||!n)return;try{e.style.display="block"}catch{}const a=document.createElement("div");a.className="file-tab",a.dataset.fileId=t.id;const o=document.createElement("div");o.className="file-tab-preview";const s=document.createElement("canvas");s.className="mini-preview",s.width=80,s.height=54,o.appendChild(s);const l=document.createElement("span");l.className="file-tab-name",l.textContent=t.name,l.title=t.name;const u=document.createElement("div");u.className="file-tab-stats",u.innerHTML="Врезки: —<br>Рез: — м<br>W: — мм H: — мм S: — м²";const p=document.createElement("div");p.className="file-tab-include";const m=document.createElement("input");m.type="checkbox",m.checked=!!t.includeInLayout,m.title="Включить деталь в раскладку",p.appendChild(m);const h=document.createElement("div");h.className="file-tab-quantity";const r=document.createElement("span");r.textContent="шт:",r.className="quantity-label";const f=document.createElement("input");f.type="number",f.value=t.quantity||1,f.min="1",f.max="999",f.className="quantity-input",f.title="Количество деталей",h.appendChild(r),h.appendChild(f);const P=document.createElement("button");P.className="file-tab-close",P.title="Убрать файл из списка",P.textContent="×";const x=document.createElement("div");x.className="file-tab-text",x.appendChild(l),x.appendChild(u);const b=document.createElement("div");b.className="file-tab-controls",b.appendChild(h);const v=document.createElement("div");v.className="file-tab-right",v.appendChild(x),v.appendChild(b),v.appendChild(p),a.appendChild(o),a.appendChild(v),a.appendChild(P),n.appendChild(a),ot(a,"click",L=>{L.target===m||L.target===f||pe(t.id)}),ot(m,"change",L=>{t.includeInLayout=!!L.target.checked,Et()}),ot(P,"click",L=>{L.stopPropagation(),Ii(t.id)}),ot(f,"input",L=>{const k=parseInt(L.target.value)||1;t.quantity=Math.max(1,Math.min(999,k)),L.target.value=t.quantity;const T=Wt();if(T&&T.id===t.id){const Q=d("qty");Q&&(Q.value=String(t.quantity))}Et()});try{t.parsed&&(Cn(s,t.parsed),qe(t))}catch{}}function ki(t,e){const n=Fi(t,e);Z.files.push(n),Ti(n);const a=d("fileTabs");return a&&(a.style.display="block"),Z.activeFileId||pe(n.id),ae(),se(),n}function Ii(t){try{const e=Z.files.findIndex(s=>s.id===t);if(e===-1)return;const n=Z.files[e];Z.files.splice(e,1);const a=document.querySelector(`.file-tab[data-file-id="${t}"]`);if(a&&a.parentElement&&a.parentElement.removeChild(a),Z.activeFileId===t){const s=Z.files[e]||Z.files[e-1]||null;Z.activeFileId=s?s.id:null,s?pe(s.id):(C.parsed=null,C.paths=[],C.piercePaths=[],C.index=null,We(),Gt())}else We(),Gt();const o=d("fileTabs");o&&(o.style.display=Z.files.length?"block":"none"),se(),$t(),ct(`Файл удалён: ${(n==null?void 0:n.name)||""}`,"ok"),Et()}catch(e){console.warn("removeFile failed:",e)}}function Mn(){Z.files.forEach(t=>{var e,n,a,o,s;t.settings||(t.settings={thickness:parseFloat(((e=d("th"))==null?void 0:e.value)||"3"),power:((n=d("power"))==null?void 0:n.value)||"1.5",gas:((a=d("gas"))==null?void 0:a.value)||"nitrogen"},console.log("Fixed missing settings for file:",t.name,t.settings)),typeof t.settings.thickness=="string"&&(t.settings.thickness=parseFloat(t.settings.thickness)),t.settings.power||(t.settings.power=((o=d("power"))==null?void 0:o.value)||"1.5"),t.settings.gas||(t.settings.gas=((s=d("gas"))==null?void 0:s.value)||"nitrogen")})}function Wt(){return Z.files.find(t=>t.id===Z.activeFileId)}function pe(t){var n,a,o;const e=Z.files.find(s=>s.id===t);if(e){const s=Wt();if(s&&(s.tab=C.tab,s.pan={...C.pan},s.zoom=C.zoom,s.hasUserTransform=!!C.hasUserTransform,s.nesting=C.nesting),Z.activeFileId=t,C.rawDXF=e.rawDXF,C.parsed=e.parsed,C.paths=e.paths,C.piercePaths=e.piercePaths,C.index=e.index,C.tab="orig",C.pan={...e.pan},C.zoom=e.zoom,C.nesting=e.nesting,e.tab="orig",e.parsed&&(C.pan=e.pan||{x:0,y:0},C.zoom=e.zoom||1,C.hasUserTransform=typeof e.hasUserTransform=="boolean"?e.hasUserTransform:!1),Li(),e.settings||(e.settings={thickness:parseFloat(((n=d("th"))==null?void 0:n.value)||"3"),power:((a=d("power"))==null?void 0:a.value)||"1.5",gas:((o=d("gas"))==null?void 0:o.value)||"nitrogen"}),e.nesting)Yi(e.nesting,e);else if(C.combinedNesting){!C.hasUserTransform&&(C.tab==="orig"||C.tab==="annot")&&Te(C,Ht);const l=Z.files.filter(u=>u.includeInLayout&&u.parsed);if(l.length>1){const u=[];l.forEach(p=>{const m=p.quantity||1;for(let h=0;h<m;h++)u.push({file:p})}),Ue(C.combinedNesting,u)}}try{qe(e)}catch{}We(),document.querySelectorAll(".tab").forEach(l=>l.classList.toggle("active",l.dataset.tab==="orig")),Gt(),se(),$t()}}function ae(){const t=d("prevFileBtn"),e=d("nextFileBtn");if(!t||!e)return;if(C.tab==="nest"&&C.combinedNesting&&Array.isArray(C.combinedNesting.sheets)){const a=C.combinedNesting.sheets.length;if(a<=1)t.disabled=!0,e.disabled=!0;else{const o=Math.max(0,Math.min(C.sheetIndex||0,a-1));t.disabled=o===0,e.disabled=o>=a-1}return}if(Z.files.length<=1){t.disabled=!0,e.disabled=!0;return}const n=Z.files.findIndex(a=>a.id===Z.activeFileId);if(n===-1){t.disabled=!0,e.disabled=!0;return}t.disabled=n===0,e.disabled=n===Z.files.length-1}function Si(){const t=Z.files.findIndex(e=>e.id===Z.activeFileId);t===-1||t>=Z.files.length-1||pe(Z.files[t+1].id)}function Ai(){const t=Z.files.findIndex(e=>e.id===Z.activeFileId);t<=0||pe(Z.files[t-1].id)}function Ri(t){const e=+d("sW").value,n=+d("sH").value,a=+d("margin").value,o=+d("spacing").value,l=d("rotations").value.split(",").map(m=>parseInt(m.trim(),10)).filter(m=>!Number.isNaN(m)),u=[];for(const m of t){const h=ve(m.parsed);if(h.w<=0||h.h<=0)continue;const r=m.quantity||1;for(let f=0;f<r;f++)u.push({file:m,width:h.w,height:h.h,partIndex:f,box:h})}if(u.length===0){ct("Нет деталей для раскладки","err");return}const p=_i(u,e,n,a,o,l);C.combinedNesting=p,C.nesting=null,Ue(p,u)}function _i(t,e,n,a,o,s){const l=[...t].sort((h,r)=>r.width*r.height-h.width*h.height),u=[],p=e-2*a,m=n-2*a;for(const h of l){let r=!1;for(const f of u)if(gn(h,f,p,m,o,s)){r=!0;break}if(!r){const f={parts:[],occupiedAreas:[]};gn(h,f,p,m,o,s)&&u.push(f)}}return{sheets:u,totalSheets:u.length,totalParts:t.length,efficiency:Di(u,e,n)}}function gn(t,e,n,a,o,s){const l=[];for(const u of s)u===0||u===180?l.push({w:t.width,h:t.height,rotation:u}):(u===90||u===270)&&l.push({w:t.height,h:t.width,rotation:u});for(const u of l){const p=$i(u.w,u.h,e,n,a,o);if(p){const m={...t,x:p.x,y:p.y,placedWidth:u.w,placedHeight:u.h,rotation:u.rotation};return e.parts.push(m),e.occupiedAreas.push({x:p.x,y:p.y,w:u.w+o,h:u.h+o}),!0}}return!1}function $i(t,e,n,a,o,s){for(let u=0;u<=o-e;u+=10)for(let p=0;p<=a-t;p+=10)if(Oi(p,u,t,e,n.occupiedAreas,s))return{x:p,y:u};return null}function Oi(t,e,n,a,o,s){const l={x:t,y:e,w:n+s,h:a+s};for(const u of o)if(Xi(l,u))return!1;return!0}function Xi(t,e){return!(t.x+t.w<=e.x||e.x+e.w<=t.x||t.y+t.h<=e.y||e.y+e.h<=t.y)}function Di(t,e,n){if(t.length===0)return 0;let a=0;for(const s of t)for(const l of s.parts)a+=l.placedWidth*l.placedHeight;const o=t.length*e*n;return a/o*100}function Ue(t,e){var b;const n=document.getElementById("nestCard");if(!n)return;n.hidden=!1;const a=new Set(e.map(v=>v.file.id));let o=0,s=0,l=0;const u={};for(const v of e){const L=v.file.id;u[L]||(u[L]={file:v.file,count:0}),u[L].count++}for(const v of Object.values(u)){const L=v.file;L.parsed&&(Number.isFinite(L.parsed.totalLen)&&(o+=L.parsed.totalLen*v.count),Number.isFinite(L.parsed.pierceCount)&&(s+=L.parsed.pierceCount*v.count),L.parsed.entities&&(l+=L.parsed.entities.length*v.count))}d("nTotalCutLength").textContent=o>0?o.toFixed(3)+" м":"—",d("nTotalPierces").textContent=s>0?s:"—";try{const v=d("nTotalCutLength"),L=d("nTotalPierces");v&&(v.dataset.value=Number.isFinite(o)?String(o):"",v.dataset.unit="m"),L&&(L.dataset.value=Number.isFinite(s)?String(s):"",L.dataset.unit="count");const k=((b=document.getElementById("status"))==null?void 0:b.textContent)||"";window.__dxMetrics={status:k,totalCutLength_m:Number.isFinite(o)?o:null,pierceCount:Number.isFinite(s)?s:null,mode:"combined"}}catch(v){console.warn("dxMetrics export (combined) failed:",v)}d("nTotalFiles").textContent=a.size,d("nTotalParts").textContent=e.length;const p=Array.isArray(t.sheets)?t.sheets.reduce((v,L)=>v+(Array.isArray(L.parts)?L.parts.length:0),0):0,m=Math.max(0,e.length-p);d("nPlaced").textContent=p,d("nSheets").textContent=t.totalSheets,d("nEff").textContent=t.efficiency.toFixed(1)+"%";const h=document.getElementById("nestingNote");h&&(m>0?h.textContent=`Часть деталей (${m} шт.) не разместилась на листах при заданных размерах/отступах/зазоре.`:h.textContent="Раскладка сеточная, повороты выбором 0/90/180/270 (180 и 0, 270 и 90 эквивалентны по габариту).");let r=Number(t.totalTime),f=Number(t.totalCost),P=Number(t.avgTimePerSheet),x=Number(t.avgCostPerSheet);(!Number.isFinite(r)||!Number.isFinite(f))&&(console.warn("Worker totals missing; consider moving all calculations to worker"),r=0,f=0,P=0,x=0),console.log("Final display values:",{avgTimePerSheet:P,avgCostPerSheet:x,totalTime:r,totalCost:f,sheets:t.totalSheets});try{!isNaN(P)&&isFinite(P)?d("nTime").textContent=P.toFixed(2)+" мин":(d("nTime").textContent="0.00 мин",console.error("Invalid avgTimePerSheet:",P)),!isNaN(r)&&isFinite(r)?d("nTotalTime").textContent=r.toFixed(2)+" мин":(d("nTotalTime").textContent="0.00 мин",console.error("Invalid totalTime:",r));const v=Le(),L=v==="RUB"?" ₽":" "+v;!isNaN(x)&&isFinite(x)?d("nCost").textContent=x.toFixed(2)+L:(d("nCost").textContent="0.00"+L,console.error("Invalid avgCostPerSheet:",x)),!isNaN(f)&&isFinite(f)?d("nTotalCost").textContent=f.toFixed(2)+L:(d("nTotalCost").textContent="0.00"+L,console.error("Invalid totalCost:",f))}catch(v){console.error("Error updating combined costs UI:",v)}d("nLayoutType").textContent="Комбинированная",setTimeout(()=>{He()},10)}function Et(){Mn();const t=Z.files.filter(e=>e.includeInLayout&&e.parsed);if(console.log("Auto calculating layout for",t.length,"included files"),t.length===0){console.log("No files to calculate layout for");const e=document.getElementById("nestCard");e&&(e.hidden=!0);return}Ci(t).catch(e=>{console.warn("Nesting worker failed, fallback to main-thread combined:",e),Ri(t)})}function Yi(t,e){var p,m,h,r,f,P;const n=document.getElementById("nestCard");if(!n)return;n.hidden=!1;const a=e.quantity||1,o=e.parsed&&Number.isFinite(e.parsed.totalLen)?(e.parsed.totalLen*a).toFixed(3)+" м":"—",s=e.parsed&&Number.isFinite(e.parsed.pierceCount)?e.parsed.pierceCount*a:"—";e.parsed&&e.parsed.entities&&e.parsed.entities.length*a,d("nTotalCutLength").textContent=o,d("nTotalPierces").textContent=s;try{const x=e.parsed&&Number.isFinite(e.parsed.totalLen)?e.parsed.totalLen*a:NaN,b=e.parsed&&Number.isFinite(e.parsed.pierceCount)?e.parsed.pierceCount*a:NaN,v=d("nTotalCutLength"),L=d("nTotalPierces");v&&(v.dataset.value=Number.isFinite(x)?String(x):"",v.dataset.unit="m"),L&&(L.dataset.value=Number.isFinite(b)?String(b):"",L.dataset.unit="count");const k=((p=document.getElementById("status"))==null?void 0:p.textContent)||"";window.__dxMetrics={status:k,totalCutLength_m:Number.isFinite(x)?x:null,pierceCount:Number.isFinite(b)?b:null,mode:"single"}}catch(x){console.warn("dxMetrics export (single) failed:",x)}d("nTotalFiles").textContent="1",d("nTotalParts").textContent=a,d("nPlaced").textContent=t.placed,d("nSheets").textContent=t.sheets;const u=t.placed*(t.pw*t.ph)/(t.W*t.H)*100;if(d("nEff").textContent=u.toFixed(1)+"%",e.parsed&&Number.isFinite(e.parsed.totalLen)&&Number.isFinite(e.parsed.pierceCount)){e.settings||(console.warn("File missing settings, initializing defaults:",e.name),e.settings={thickness:parseFloat(((m=d("th"))==null?void 0:m.value)||"3"),power:((h=d("power"))==null?void 0:h.value)||"1.5",gas:((r=d("gas"))==null?void 0:r.value)||"nitrogen"});const x=e.settings.thickness,b=e.settings.power,v=e.settings.gas;if(console.log("Single file cost calculation for:",e.name,{th:x,power:b,gas:v,totalLen:e.parsed.totalLen,pierceCount:e.parsed.pierceCount,placed:t.placed,sheets:t.sheets}),!x||!b||!v){console.warn("Missing settings for file:",e.name,{th:x,power:b,gas:v}),d("nTime").textContent="Нет данных",d("nTotalTime").textContent="Нет данных",d("nCost").textContent="Нет данных",d("nTotalCost").textContent="Нет данных";return}const{can:L,speed:k,pierce:T,gasCons:Q}=zt(b,x,v);if(L){const nt=e.parsed.totalLen*1e3/k,ht=e.parsed.pierceCount*T/60,ut=nt+ht,pt=t.placed===0,_t=a,wt=pt?NaN:ut*t.placed,Tt=ut*_t;try{!pt&&!isNaN(wt)&&isFinite(wt)?d("nTime").textContent=wt.toFixed(2)+" мин":pt?d("nTime").textContent="—":(d("nTime").textContent="0.00 мин",console.error("Invalid timePerSheet value:",wt)),!isNaN(Tt)&&isFinite(Tt)?d("nTotalTime").textContent=Tt.toFixed(2)+" мин":(d("nTotalTime").textContent="0.00 мин",console.error("Invalid totalTime value:",Tt))}catch(yt){console.error("Error updating time display:",yt)}const E=Me(x);let M,gt,Lt,It,Jt=Le();if(E){Jt=E.currency||Jt;const yt=e.parsed.totalLen*1e3,oe=e.parsed.pierceCount;It=(E.cutPerMm*yt+E.pierce*oe+E.machineHourPrice/60*ut)*(1+(E.markupPercent||0)/100),M=E.cutPerMm*yt,gt=E.pierce*oe,Lt=E.machineHourPrice/60*ut,console.log("Pricing (pricing.md):",{thickness:x,currency:Jt,cutPerMm:E.cutPerMm,pierce:E.pierce,machineHourPrice:E.machineHourPrice,markupPercent:E.markupPercent})}else{const yt=parseFloat(d("pPerM").value)||100,oe=parseFloat(d("pPierce").value)||50,Pt=parseFloat(d("machPrice").value)||500;M=yt*e.parsed.totalLen,gt=oe*e.parsed.pierceCount,Lt=Pt/60*ut;const me=(((P=(f=kt())==null?void 0:f.pricing)==null?void 0:P.markupPercent)||0)/100;It=(M+gt+Lt)*(1+me),console.warn("Fallback pricing used (config inputs). Consider defining thickness in pricing.md",x)}const Kt=pt?NaN:It*t.placed,Qt=It*_t;console.log("Cost calculation:",{cutRubPerPart:M,pierceRubPerPart:gt,machRubPerPart:Lt,totalRubPerPart:It,costPerSheet:Kt,totalCost:Qt,isOversize:pt});try{const yt=Jt==="RUB"?" ₽":" "+Jt;!pt&&!isNaN(Kt)&&isFinite(Kt)?d("nCost").textContent=Kt.toFixed(2)+yt:pt?d("nCost").textContent="—":(d("nCost").textContent="0.00"+yt,console.error("Invalid costPerSheet value:",Kt)),!isNaN(Qt)&&isFinite(Qt)?d("nTotalCost").textContent=Qt.toFixed(2)+yt:(d("nTotalCost").textContent="0.00"+yt,console.error("Invalid totalCost value:",Qt))}catch(yt){console.error("Error updating cost display:",yt)}if(pt){const yt=document.getElementById("nestingNote");yt&&(yt.textContent="Деталь не помещается на лист при заданных размерах листа/отступа/зазора. Итоги посчитаны по общему количеству деталей.")}}else console.warn("Cannot calculate costs for file:",e.name,"Settings:",e.settings),d("nTime").textContent="Невозможно рассчитать",d("nTotalTime").textContent="Невозможно рассчитать",d("nCost").textContent="Невозможно рассчитать",d("nTotalCost").textContent="Невозможно рассчитать"}else d("nTime").textContent="Нет данных",d("nTotalTime").textContent="Нет данных",d("nCost").textContent="Нет данных",d("nTotalCost").textContent="Нет данных";d("nLayoutType").textContent="Одиночная ("+t.rot+"°)",setTimeout(()=>{typeof He=="function"?He():console.error("setupDetailsToggle is not a function")},10)}function We(){const t=Wt();if(t){document.querySelectorAll(".file-tab").forEach(a=>{a.classList.toggle("active",a.dataset.fileId===t.id)});const n={th:d("th"),power:d("power"),gas:d("gas"),qty:d("qty")};n.th&&(n.th.value=t.settings.thickness),n.power&&(n.power.value=t.settings.power),n.gas&&(n.gas.value=t.settings.gas),n.qty&&(n.qty.value=t.quantity||1),document.querySelectorAll(".tab").forEach(a=>{a.classList.toggle("active",a.dataset.tab===t.tab)}),Ot.lastParams=null,Ot.lastResult=null}const e=d("calc");e&&(e.disabled=!t||!t.parsed),ae(),se()}function Hi(){const t=Wt();if(t){const e=parseInt(d("qty").value)||1;t.quantity=Math.max(1,Math.min(999,e));const n=document.querySelector(`.file-tab[data-file-id="${t.id}"] .quantity-input`);n&&(n.value=t.quantity),Et()}}function yn(){document.querySelectorAll(".tab").forEach(r=>ot(r,"click",()=>{C.tab=r.dataset.tab,document.querySelectorAll(".tab").forEach(f=>f.classList.toggle("active",f===r)),se(),ae(),C.parsed&&(C.tab==="orig"||C.tab==="annot")&&!C.hasUserTransform&&Te(C,Ht),$t()}));const t=d("nestLabels");if(t){try{const r=localStorage.getItem("showNestingLabels");r!==null&&(C.showNestingLabels=r==="true")}catch{}t.checked=!!C.showNestingLabels,ot(t,"change",r=>{C.showNestingLabels=!!r.target.checked;try{localStorage.setItem("showNestingLabels",String(C.showNestingLabels))}catch{}C.tab==="nest"&&$t()})}const e=d("prevFileBtn"),n=d("nextFileBtn");e&&ot(e,"click",()=>{if(C.tab==="nest"&&C.combinedNesting&&Array.isArray(C.combinedNesting.sheets)&&C.combinedNesting.sheets.length>1){C.sheetIndex=Math.max(0,(C.sheetIndex||0)-1),$t(),ae();return}Ai(),ae()}),n&&ot(n,"click",()=>{if(C.tab==="nest"&&C.combinedNesting&&Array.isArray(C.combinedNesting.sheets)&&C.combinedNesting.sheets.length>1){const r=C.combinedNesting.sheets.length;C.sheetIndex=Math.min(r-1,(C.sheetIndex||0)+1),$t(),ae();return}Si(),ae()}),ot(d("calc"),"click",()=>{C.parsed&&(Pe(),Gt(),C.tab="annot",document.querySelectorAll(".tab").forEach(r=>r.classList.toggle("active",r.dataset.tab==="annot")),$t())});const a=d("exportToggle"),o=d("exportContent"),s=d("exportHeader"),l=localStorage.getItem("exportSectionExpanded"),u=l?JSON.parse(l):!1;a&&o&&(u&&(o.style.display="block",o.classList.add("expanded"),a.classList.add("expanded"),a.textContent="▼",a.title="Скрыть экспорт"),ot(a,"click",r=>{r.stopPropagation(),o.classList.contains("expanded")?(o.classList.remove("expanded"),a.classList.remove("expanded"),a.textContent="▶",a.title="Показать экспорт",localStorage.setItem("exportSectionExpanded","false"),setTimeout(()=>{o.style.display="none"},300)):(o.style.display="block",localStorage.setItem("exportSectionExpanded","true"),setTimeout(()=>{o.classList.add("expanded"),a.classList.add("expanded"),a.textContent="▼",a.title="Скрыть экспорт"},10))}),ot(s,"click",r=>{r.target!==a&&a.click()})),ot(d("th"),"change",()=>{if(C.parsed){Pe(),Gt(),Pn();const r=Wt();r&&(r.settings.thickness=parseFloat(d("th").value)),console.log("Recalculating layout after thickness change"),Et()}ne()}),ot(d("power"),"change",()=>{if(C.parsed){Pe(),Gt();const r=Wt();r&&(r.settings.power=d("power").value),console.log("Recalculating layout after power change"),Et()}ne()}),ot(d("gas"),"change",()=>{if(C.parsed){Pe(),Gt();const r=Wt();r&&(r.settings.gas=d("gas").value),console.log("Recalculating layout after gas change"),Et()}ne()}),ot(d("sW"),"input",ne),ot(d("sH"),"input",ne),ot(d("margin"),"input",ne),ot(d("spacing"),"input",ne),ot(d("sW"),"change",Et),ot(d("sH"),"change",Et),ot(d("margin"),"change",Et),ot(d("spacing"),"change",Et),ot(d("qty"),"input",Hi),ot(d("rotations"),"change",()=>{ne(),Et()}),ot(d("calc"),"click",()=>{C.parsed&&(console.log("Calculate button clicked - recalculating parameters"),Pe(),Gt(),(C.nesting||C.combinedNesting)&&(console.log("Recalculating layout with updated parameters"),Et()),C.tab="annot",document.querySelectorAll(".tab").forEach(r=>r.classList.toggle("active",r.dataset.tab==="annot")),$t())});const p=d("fillSheet");p&&ot(p,"click",()=>{wi()}),ot(d("dlPDF"),"click",async()=>{const r=d("dlPDF"),f=r.textContent;try{const P=C.combinedNesting||C.nesting;if(!P){ct("Сначала выполните раскладку","err");return}r.disabled=!0,r.textContent="🔄 Загрузка библиотеки...",ct("Подготовка создания PDF отчета...","warn");const x=C.combinedNesting?Z.files.filter(T=>T.includeInLayout&&T.parsed):[Wt()];if(console.log("PDF Generation Data:"),console.log("- Layout:",P),console.log("- Files count:",x.length),console.log("- Active file:",Wt()),x.length===0)throw new Error("Нет файлов для создания отчета");r.textContent="📋 Генерация PDF...",ct("Генерация PDF отчета...","warn");const b={state:C,layout:P,files:x};if(console.log("PDF report data:",b),!b.layout&&!b.files)throw new Error("Нет данных для создания отчета");const v=b.files.filter(T=>T&&T.parsed);if(v.length===0)throw new Error("Нет корректных данных для создания отчета");let L=!1;for(const T of v)if(T.parsed&&(T.parsed.totalLen>0||T.parsed.pierceCount>0)){L=!0;break}L||(console.warn("No calculation data found, using mock data for testing"),b.layout=b.layout||{sheets:1,totalSheets:1,efficiency:75,sheetWidth:1250,sheetHeight:2500},v.length===0&&x.length>0&&(b.files=[{name:x[0].name||"Тестовый файл",parsed:{totalLen:10.5,pierceCount:5,entities:[{},{},{}]},calculatedCost:{timeForAllParts:15.2,costForAllParts:1520}}]));const{generatePDFReport:k}=await un(async()=>{const{generatePDFReport:T}=await import("./pdf-export-html2pdf-CCIFDSLw.js");return{generatePDFReport:T}},[]);await k(b,"dxf-pro-report.pdf"),ct("PDF отчет успешно создан и скачан","ok")}catch(P){console.error("PDF export error:",P);let x="Ошибка экспорта PDF";P.message.includes("html2pdf")?x+=": Проблема с загрузкой библиотеки. Проверьте интернет-соединение.":x+=`: ${P.message}`,ct(x,"err")}finally{r.disabled=!1,r.textContent=f}}),ot(d("dlJPEG"),"click",async()=>{try{const r=C.combinedNesting||C.nesting;if(!r){ct("Сначала выполните раскладку","err");return}ct("Экспорт раскладки в JPEG...","warn");const{exportLayoutAsJPEG:f}=await un(async()=>{const{exportLayoutAsJPEG:P}=await import("./jpeg-export-C4KiegQT.js");return{exportLayoutAsJPEG:P}},[]);f(C,Ht,r),ct("Раскладка экспортирована в JPEG","ok")}catch(r){console.error("JPEG export error:",r),ct(`Ошибка экспорта JPEG: ${r.message}`,"err")}}),ot(d("file"),"change",r=>{const f=Array.from(r.target.files).filter(P=>P.name.toLowerCase().endsWith(".dxf"));f.length>0&&qi(f);try{d("file").value=""}catch{}});const m=d("addFileBtn");m&&ot(m,"click",()=>{d("file").click()});const h=di({parseDXF:vn,sanitizeParsed:wn,computeNesting:ue});ot(d("runTests"),"click",h);try{const f=new URLSearchParams(window.location.search).get("tests");(f==="1"||f==="true")&&setTimeout(()=>{try{h()}catch(P){console.error("Автозапуск тестов не удался:",P)}},0)}catch(r){console.warn("Не удалось прочитать параметр tests из URL:",r)}ct("Готово к работе","ok")}let Vt=null;try{Vt=new Worker(new URL("/assets/parser-worker-l011_12L.js",import.meta.url),{type:"module"}),Vt.onerror=t=>console.error("[worker error]",t.message)}catch(t){console.warn("Worker init failed:",t),Vt=null}function Wi(t,e=6e3){return new Promise((n,a)=>{if(!Vt)return a(new Error("no-worker"));let o=setTimeout(()=>{Vt.removeEventListener("message",s),a(new Error("timeout"))},e);function s(l){clearTimeout(o),Vt.removeEventListener("message",s),n(l.data)}Vt.addEventListener("message",s),Vt.postMessage(t)})}async function vn(t){const e=kt(),n=e&&e.parser&&Number.isFinite(Number(e.parser.tolerance))?Number(e.parser.tolerance):.1,a=e&&e.parser&&e.parser.closureTolerance!=null&&Number.isFinite(Number(e.parser.closureTolerance))?Number(e.parser.closureTolerance):n,o={text:t,options:{tolerance:n,closureTolerance:a}};if(Vt)try{const s=await Wi(o,6e3);if(s&&s.ok)return s.res;console.warn("Worker returned error, fallback to main thread:",s==null?void 0:s.err)}catch(s){console.warn("Worker timeout/fail, fallback to main thread:",s)}return ti(o)}async function Nn(t){var e,n;try{console.log("Loading file:",t.name,"size:",t.size),ct(`Загрузка ${t.name}...`,"warn"),jt.startTimer("file_load_total"),jt.startTimer("file_read");const a=await t.text();jt.endTimer("file_read"),console.log("File read, content length:",a.length);const o=ki(t,a);ct(`Парсинг ${t.name}...`,"warn");const s=await we("dxf_parsing",async()=>wn(await vn(a)));if(console.log("DXF parsed, entities:",((e=s==null?void 0:s.entities)==null?void 0:e.length)||0),s.validationErrors&&s.validationErrors.length>0){console.warn("Validation errors found:",s.validationErrors);const m=s.validationErrors.length,h=5,r=s.validationErrors.slice(0,h),f=m>h?` (и еще ${m-h})`:"";ct(`Предупреждения в ${t.name}: ${r.join("; ")}${f}`,"warn")}if(!s||!s.entities||s.entities.length===0)throw new Error(`Не найдено объектов в ${t.name}`);o.parsed=s;const l=document.querySelector(`[data-file-id="${o.id}"]`);if(l){const m=l.querySelector(".mini-preview");m&&Cn(m,s);try{qe(o)}catch{}}console.log("Building paths for",t.name),we("path_building",()=>{const m=(s==null?void 0:s.entities)||[];o.paths=[],o.piercePaths=[];for(let r=0;r<m.length;r++){const f=m[r];if(!f||!f.raw){o.paths.push(new Path2D);continue}const P=new Path2D;try{if(f.type==="LINE"){const{x1:x,y1:b,x2:v,y2:L}=f.raw;[x,b,v,L].every(Number.isFinite)&&(P.moveTo(x,b),P.lineTo(v,L))}else if(f.type==="CIRCLE"){const{cx:x,cy:b,r:v}=f.raw;[x,b,v].every(Number.isFinite)&&v>0&&(P.moveTo(x+v,b),P.arc(x,b,v,0,Math.PI*2,!1))}else if(f.type==="ARC"){const{cx:x,cy:b,r:v,a1:L=0,a2:k=0}=f.raw;if([x,b,v,L,k].every(Number.isFinite)&&v>0){let T=L*Math.PI/180,nt=k*Math.PI/180-T;nt<0&&(nt+=2*Math.PI);const ht=Math.max(24,Math.min(360,Math.ceil(v*nt/1.5)));for(let ut=0;ut<=ht;ut++){const pt=T+nt*(ut/ht),_t=x+v*Math.cos(pt),wt=b+v*Math.sin(pt);ut===0?P.moveTo(_t,wt):P.lineTo(_t,wt)}}}else if(f.type==="POLY"){const x=f.raw.pts||[];if(x.length&&x.every(b=>Number.isFinite(b.x)&&Number.isFinite(b.y))){P.moveTo(x[0].x,x[0].y);for(let b=1;b<x.length;b++)P.lineTo(x[b].x,x[b].y);f.raw.closed&&P.closePath()}}}catch(x){console.error("Error creating path for entity",r,":",x)}o.paths.push(P)}const h=(s==null?void 0:s.piercePts)||[];for(const r of h)if(!(!r||!Array.isArray(r)||r.length<2)&&!(!Number.isFinite(r[0])||!Number.isFinite(r[1])))try{const f=new Path2D,P=3;f.moveTo(r[0]+P,r[1]),f.arc(r[0],r[1],P,0,Math.PI*2,!1),o.piercePaths.push(f)}catch(f){console.error("Error creating pierce path:",f)}}),console.log("Paths built, count:",((n=o.paths)==null?void 0:n.length)||0),pe(o.id),["calc","nest","dlAnn","dlPDF","dlJPEG"].forEach(m=>{const h=d(m);h&&(h.disabled=!1)});const u=d("dl"),p=d("exportContent");if(u){u.hidden=!1;const m=localStorage.getItem("exportSectionExpanded"),h=m?JSON.parse(m):!0;p&&h&&(p.style.display="block",setTimeout(()=>{p.classList.add("expanded");const r=d("exportToggle");r&&(r.classList.add("expanded"),r.textContent="▼",r.title="Скрыть экспорт")},10))}console.log("Updating cards..."),we("cards_update",()=>{Gt()}),console.log("Fitting view..."),we("view_fit",()=>{Te(C,Ht)}),console.log("Drawing..."),we("initial_draw",()=>{$t()}),jt.endTimer("file_load_total"),console.log("File loaded successfully:",t.name),console.log("Performance report:",jt.getReport()),ct(`Готово: ${t.name} - объектов: ${s.entities.length}, длина: ${s.totalLen.toFixed(3)} м`,"ok"),Mn(),Et()}catch(a){console.error("Error loading file:",t.name,a),ct(`Ошибка в ${t.name}: `+((a==null?void 0:a.message)||String(a)),"err")}}async function qi(t){if(!t||t.length===0)return;ct(`Загрузка ${t.length} файлов...`,"warn");for(let n=0;n<t.length;n++)await Nn(t[n]);const e=Z.files.filter(n=>n.includeInLayout&&n.parsed);ct(`Успешно загружено ${t.length} файлов, в раскладке: ${e.length}`,"ok"),Et()}function Pe(){const t=parseFloat(d("th").value),e=d("power").value,n=d("gas").value,a=zt(e,t,n);Ot.lastParams=null,Ot.lastResult=null,d("cutSpd").value=a.can?a.speed:0,d("pierceSec").value=a.can?a.pierce.toFixed(2):0}let Ot={lastParams:null,lastResult:null};function Gt(){var m,h;if(!C.parsed)return;const t={th:d("th"),power:d("power"),gas:d("gas"),pPerM:d("pPerM"),pPierce:d("pPierce"),gasPrice:d("gasPrice"),machPrice:d("machPrice")},e=parseFloat(t.th.value),n=t.power.value,a=t.gas.value,o=`${e}-${n}-${a}-${C.parsed.totalLen}-${C.parsed.pierceCount}`;let s;if(Ot.lastParams===o)s=Ot.lastResult;else{const{can:r,speed:f,pierce:P}=zt(n,e,a),x=r?C.parsed.totalLen*1e3/f:0,b=r?C.parsed.pierceCount*P/60:0,v=x+b,L=Me(e);Le();let k=0,T=0,Q=0,nt=0,ht=0;if(L){const ut=C.parsed.totalLen*1e3;k=L.cutPerMm*ut,T=L.pierce*C.parsed.pierceCount,Q=L.machineHourPrice/60*v,ht=(k+T+Q)*(1+(L.markupPercent||0)/100)}else{const ut=parseFloat(t.pPerM.value)||100,pt=parseFloat(t.pPierce.value)||50,_t=parseFloat(t.machPrice.value)||500;k=ut*C.parsed.totalLen,T=pt*C.parsed.pierceCount,Q=_t/60*v;const wt=(((h=(m=kt())==null?void 0:m.pricing)==null?void 0:h.markupPercent)||0)/100;ht=(k+T+Q)*(1+wt)}s={cutMin:x,pierceMin:b,totalMin:v,cutRub:k,pierceRub:T,gasRub:nt,machRub:Q,totalRub:ht},Ot.lastParams=o,Ot.lastResult=s}const l=Le(),u=l==="RUB"?" ₽":" "+l,p={mLen:C.parsed.totalLen.toFixed(3)+" м",mPierce:C.parsed.pierceCount,mEnt:C.parsed.entities.length,mCutMin:s.cutMin.toFixed(2)+" мин",mPierceMin:s.pierceMin.toFixed(2)+" мин",mTotalMin:s.totalMin.toFixed(2)+" мин",mCutRub:s.cutRub.toFixed(2)+u,mPierceRub:s.pierceRub.toFixed(2)+u,mGasRub:(s.gasRub||0).toFixed(2)+u,mMachRub:s.machRub.toFixed(2)+u,mTotalRub:s.totalRub.toFixed(2)+u};requestAnimationFrame(()=>{for(const[r,f]of Object.entries(p)){const P=d(r);P&&(P.textContent=f)}})}function Cn(t,e){const n=t.getContext("2d"),a=t.width,o=t.height;if(n.clearRect(0,0,a,o),!e||!e.entities||e.entities.length===0){n.fillStyle="#0b1222",n.fillRect(0,0,a,o),n.strokeStyle="#9db4ff",n.lineWidth=1,n.strokeRect(.5,.5,a-1,o-1);return}const s=Ui(e.entities);if(s.maxX<=s.minX||s.maxY<=s.minY)return;const l=s.maxX-s.minX,u=s.maxY-s.minY,p=2,m=(a-2*p)/l,h=(o-2*p)/u,r=Math.min(m,h),f=(a-l*r)/2-s.minX*r,P=(o-u*r)/2-s.minY*r;n.save(),n.translate(f,P),n.scale(r,-r),n.translate(0,-s.maxY-s.minY),n.strokeStyle="#77a1ff",n.lineWidth=1/r;for(const x of e.entities)if(!(!x||!x.raw)){if(n.beginPath(),x.type==="LINE"){const{x1:b,y1:v,x2:L,y2:k}=x.raw;n.moveTo(b,v),n.lineTo(L,k)}else if(x.type==="CIRCLE"){const{cx:b,cy:v,r:L}=x.raw;n.arc(b,v,L,0,Math.PI*2)}else if(x.type==="ARC"){const{cx:b,cy:v,r:L,a1:k=0,a2:T=0}=x.raw,Q=k*Math.PI/180,nt=T*Math.PI/180;n.arc(b,v,L,Q,nt)}else if(x.type==="POLY"){const b=x.raw.pts||[];if(b.length>0){n.moveTo(b[0].x,b[0].y);for(let v=1;v<b.length;v++)n.lineTo(b[v].x,b[v].y);x.raw.closed&&n.closePath()}}n.stroke()}n.restore()}function Ui(t){let e=1/0,n=1/0,a=-1/0,o=-1/0;for(const s of t)if(!(!s||!s.raw)){if(s.type==="LINE"){const{x1:l,y1:u,x2:p,y2:m}=s.raw;e=Math.min(e,l,p),n=Math.min(n,u,m),a=Math.max(a,l,p),o=Math.max(o,u,m)}else if(s.type==="CIRCLE"){const{cx:l,cy:u,r:p}=s.raw;e=Math.min(e,l-p),n=Math.min(n,u-p),a=Math.max(a,l+p),o=Math.max(o,u+p)}else if(s.type==="ARC"){const{cx:l,cy:u,r:p}=s.raw;e=Math.min(e,l-p),n=Math.min(n,u-p),a=Math.max(a,l+p),o=Math.max(o,u+p)}else if(s.type==="POLY"){const l=s.raw.pts||[];for(const u of l)e=Math.min(e,u.x),n=Math.min(n,u.y),a=Math.max(a,u.x),o=Math.max(o,u.y)}}return{minX:e,minY:n,maxX:a,maxY:o}}function xn(){try{if(window.__DXF_SKIP_AUTOLOAD__)return;const e=new URLSearchParams(window.location.search).get("src");if(!e)return;const n=new URL(e,window.location.href).href;let a="file.dxf";try{const s=new URL(n).pathname;a=decodeURIComponent(s.substring(s.lastIndexOf("/")+1))||a}catch{}ct("Автозагрузка DXF из URL…","warn"),fetch(n).then(async o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);const s=await o.blob(),l=new File([s],a,{type:s.type||"application/dxf"});return Nn(l)}).then(()=>{ct(`Файл загружен: ${a}`,"ok")}).catch(o=>{console.error("Autoload failed:",o),ct("Не удалось автозагрузить DXF: "+((o==null?void 0:o.message)||String(o)),"err")})}catch(t){console.warn("tryAutoloadFromUrl error:",t)}}try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{try{dn().then(()=>{mn(),se()}).catch(t=>console.warn("loadConfig failed:",t)),Ht=d("cv"),Ht&&fn(C,Ht,$t),yn(),ct("Готово к работе","ok"),xn()}catch(t){console.error("Init error:",t)}}):(dn().then(()=>{mn(),se()}).catch(t=>console.warn("loadConfig failed:",t)),Ht=d("cv"),Ht&&fn(C,Ht,$t),yn(),ct("Готово к работе","ok"),xn())}catch(t){console.error("Failed to bootstrap app:",t)}function En(){const t=o=>fetch("/__ai_error",{method:"POST",body:JSON.stringify(o)}).catch(()=>{}),e=o=>{if(!o)return{};const s=o.match(/\(?([A-Za-z]:)?[^\n:()]+\.(?:ts|tsx|js|jsx)(?::(\d+))?(?::(\d+))?/);return s?{file:(s[1],s[0]),line:s[2]?Number(s[2]):void 0,col:s[3]?Number(s[3]):void 0}:{}},n=o=>{let s=2166136261;for(let l=0;l<o.length;l++)s^=o.charCodeAt(l),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return(s>>>0).toString(16)},a=()=>{var o,s,l,u,p,m,h,r,f,P,x;return{timestamp:new Date().toISOString(),appVersion:(s=(o=import.meta)==null?void 0:o.env)==null?void 0:s.VITE_APP_VERSION,vite:{mode:(u=(l=import.meta)==null?void 0:l.env)==null?void 0:u.MODE,hmr:!!((p=import.meta)!=null&&p.hot)},env:{DEV:(h=(m=import.meta)==null?void 0:m.env)==null?void 0:h.DEV,PROD:(f=(r=import.meta)==null?void 0:r.env)==null?void 0:f.PROD,MODE:(x=(P=import.meta)==null?void 0:P.env)==null?void 0:x.MODE},route:location.pathname,userAgent:navigator.userAgent}};window.addEventListener("error",o=>{var m;const s=a(),l=((m=o.error)==null?void 0:m.stack)||"",u=e(l),p=n(`${o.message}|${s.route}|${u.file||""}|${u.line||0}`);t({...s,fingerprint:p,error:{message:o.message,stack:l},artifacts:{suspectFile:u.file,suspectLine:u.line,suspectCol:u.col}})}),window.addEventListener("unhandledrejection",o=>{const s=a(),l=o==null?void 0:o.reason,u=typeof l=="string"?l:(l==null?void 0:l.message)??String(l),p=typeof l=="object"&&typeof(l==null?void 0:l.stack)=="string"?l.stack:typeof l=="string"?l:"",m=e(p),h=n(`${u}|${s.route}|${m.file||""}|${m.line||0}`);t({...s,fingerprint:h,error:{message:u,stack:p},artifacts:{suspectFile:m.file,suspectLine:m.line,suspectCol:m.col}})})}En();window.__initAiErrorCapture=En;
