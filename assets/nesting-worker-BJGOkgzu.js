(function(){"use strict";function R(e,t){return!(e.x+e.w<=t.x||t.x+t.w<=e.x||e.y+e.h<=t.y||t.y+t.h<=e.y)}function v(e,t,r,l,s,h){const i={x:e,y:t,w:r+h,h:l+h};for(const o of s)if(R(i,o))return!1;return!0}function I(e,t,r,l,s,h){for(let o=0;o<=s-t;o+=10)for(let n=0;n<=l-e;n+=10)if(v(n,o,e,t,r.occupiedAreas,h))return{x:n,y:o};return null}function x(e,t,r,l,s,h){const i=[];for(const o of h){const n=(o%360+360)%360;n===0||n===180?i.push({w:e.width,h:e.height,rotation:n}):(n===90||n===270)&&i.push({w:e.height,h:e.width,rotation:n})}for(const o of i){const n=I(o.w,o.h,t,r,l,s);if(n){const p={...e,x:n.x,y:n.y,placedWidth:o.w,placedHeight:o.h,rotation:o.rotation};return t.parts.push(p),t.occupiedAreas.push({x:n.x,y:n.y,w:o.w+s,h:o.h+s}),!0}}return!1}function k(e,t,r){if(e.length===0)return 0;let l=0;for(const h of e)for(const i of h.parts)l+=i.placedWidth*i.placedHeight;const s=e.length*t*r;return l/s*100}function F(e,t,r,l,s,h){const i=[...e].sort((a,u)=>u.width*u.height-a.width*a.height),o=[],n=t-2*l,p=r-2*l;if(i.length>0&&i.every(a=>a.width===i[0].width&&a.height===i[0].height)){const a=i[0].width,u=i[0].height,d=Array.from(new Set(h.map(c=>(c%360+360)%360))),w=[];for(const c of d)c===0||c===180?w.push({w:a,h:u,rotation:c}):(c===90||c===270)&&w.push({w:u,h:a,rotation:c});w.length===0&&w.push({w:a,h:u,rotation:0});let f={cols:0,rows:0,w:a,h:u,rotation:w[0].rotation};for(const c of w){const P=Math.max(0,Math.floor((n+s)/(c.w+s))),g=Math.max(0,Math.floor((p+s)/(c.h+s)));P*g>f.cols*f.rows&&(f={cols:P,rows:g,w:c.w,h:c.h,rotation:c.rotation})}let m=i.length;for(;m>0;){const c={parts:[],occupiedAreas:[]},P=f.cols,g=f.rows;let S=0;for(let M=0;M<g&&m>0;M++)for(let b=0;b<P&&m>0;b++){const A=b*(f.w+s),C=M*(f.h+s);c.parts.push({...i[i.length-m],x:A,y:C,placedWidth:f.w,placedHeight:f.h,rotation:f.rotation}),c.occupiedAreas.push({x:A,y:C,w:f.w+s,h:f.h+s}),m--,S++}if(o.push(c),S===0)break}return{sheets:o,totalSheets:o.length,totalParts:e.length,efficiency:k(o,t,r)}}for(const a of i){let u=!1;for(const d of o)if(x(a,d,n,p,s,h)){u=!0;break}if(!u){const d={parts:[],occupiedAreas:[]};x(a,d,n,p,s,h),o.push(d)}}return{sheets:o,totalSheets:o.length,totalParts:e.length,efficiency:k(o,t,r)}}function H(e){const t=[];for(const r of e){const l=Math.max(0,Math.floor(r.qty||0));for(let s=0;s<l;s++)t.push({fileId:r.fileId,width:r.pw,height:r.ph,settings:r.settings,metrics:r.metrics,tariff:r.tariff,params:r.params})}return t}function L(e,t){const r=new Map;for(const o of t){const n=o.fileId;r.has(n)||r.set(n,{count:0,sample:o}),r.get(n).count++}let l=0,s=0;for(const{count:o,sample:n}of r.values()){const{metrics:p,tariff:y,params:a}=n;if(!a||!Number.isFinite(a.speed)||!Number.isFinite(a.pierce)||a.speed<=0)continue;const u=a.speed,d=a.pierce,w=p.totalLen*1e3/u,f=p.pierceCount*d/60,m=w+f,c=p.totalLen*1e3,P=p.pierceCount,g=y.cutPerMm*c,S=y.pierce*P,M=y.machineHourPrice/60*m,b=(y.markupPercent||0)/100,A=(g+S)*(1+b)+M;l+=m*o,s+=A*o}const h=e.totalSheets>0?l/e.totalSheets:0,i=e.totalSheets>0?s/e.totalSheets:0;return{totalTime:l,totalCost:s,avgTimePerSheet:h,avgCostPerSheet:i}}self.onmessage=async e=>{try{const{sheet:t,parts:r}=e.data||{};if(!t||!Array.isArray(r)){self.postMessage({ok:!1,error:"bad-input"});return}const l=Array.isArray(t.rotations)?t.rotations:[0,90],s=H(r),h=F(s,t.width,t.height,t.margin,t.spacing,l),i=L(h,s),o={ok:!0,layout:{...h,...i},partsCount:s.length};self.postMessage(o)}catch(t){self.postMessage({ok:!1,error:String(t&&t.message||t)})}}})();
