(function(){"use strict";typeof self<"u"&&typeof self.postMessage=="function"&&(self.onmessage=Lt=>{try{const A=Lt.data;let Q;A&&typeof A=="object"&&typeof A.text=="string"?Q=Rt(A.text,A.options||{}):Q=Rt(A),self.postMessage({ok:!0,res:Q})}catch(A){self.postMessage({ok:!1,err:String(A&&A.message?A.message:A)})}});function Rt(Lt,A){const Q=A||{},V=Math.max(1e-6,Number((Q&&Q.tolerance)??.1)),ut=Math.max(1e-6,Number((Q&&Q.closureTolerance)??V)),Z=String(Lt||"").split(/\r?\n/),ee=Z.length;let ht=0;function yt(){if(ht+1>=ee)return null;const t=parseInt((Z[ht++]||"").trim(),10),e=(Z[ht++]||"").trim();return Number.isNaN(t)?yt():{code:t,value:e}}function xt(t){return String(t||"").toUpperCase()}function Et(t,e,a){const s=Math.max(1e-9,Number(t)||0),n=Math.max(1e-9,Number(e)||.001),i=Math.max(1e-6,Math.abs(Number(a)||0)),f=Math.max(-1,Math.min(1,1-n/s)),h=Math.max(1e-4,2*Math.acos(f));return Math.ceil(Math.max(8,Math.min(2048,i/h)))}function Nt(t,e){var D,at,Mt,bt,Vt,Wt;const a=t.data&&t.data.name||"",s=Ft.map.get(a);if(!s)return ce("DXF_MISSING_BLOCK",`INSERT references missing block: ${a}`),[];const n=Math.max(1,Number.isFinite((D=t.data)==null?void 0:D.rows)?t.data.rows:1),i=Math.max(1,Number.isFinite((at=t.data)==null?void 0:at.cols)?t.data.cols:1),f=Number.isFinite((Mt=t.data)==null?void 0:Mt.rowSpacing)?t.data.rowSpacing:0,h=Number.isFinite((bt=t.data)==null?void 0:bt.colSpacing)?t.data.colSpacing:0,o=Number(t.data.x)||0,c=Number(t.data.y)||0,l=Number.isFinite(t.data.sx)?t.data.sx:1,u=Number.isFinite(t.data.sy)?t.data.sy:l,x=(Number.isFinite(t.data.rot)?t.data.rot:0)*Math.PI/180,g=Math.abs(l-u)>1e-9,P=Math.cos(x),L=Math.sin(x),E=P*l,M=L*l,m=-L*u,S=P*u,J=Number((Vt=s.basePoint)==null?void 0:Vt.x)||0,ct=Number((Wt=s.basePoint)==null?void 0:Wt.y)||0,$=y=>{const b=(y||"").trim();return!b||b==="0"?t.data.layer||void 0:b};function v(y,b,N){const _=y.x-J,C=y.y-ct,Y=_*P-C*L,p=_*L+C*P;return{x:b+Y*l,y:N+p*u}}const I=[];function st(y,b,N){I.push({type:"POLY",data:{layer:N},verts:[],raw:{pts:y,closed:b}})}function rt(y,b,N){const _=y.type;if(_==="LINE"){const C=(e?p=>e.tx(v(p,b,N)):p=>v(p,b,N))({x:y.data.x1||0,y:y.data.y1||0}),Y=(e?p=>e.tx(v(p,b,N)):p=>v(p,b,N))({x:y.data.x2||0,y:y.data.y2||0});I.push({type:"LINE",data:{x1:C.x,y1:C.y,x2:Y.x,y2:Y.y,layer:$(y.data.layer)}})}else if(_==="CIRCLE")if(g){const C=y.data.cx||0,Y=y.data.cy||0,p=y.data.r||0,X=Math.max(Math.abs(l*p),Math.abs(u*p)),R=Et(X,typeof V<"u"?V:.1,2*Math.PI),z=[];for(let F=0;F<R;F++){const k=2*Math.PI*F/R,j=(e?K=>e.tx(v(K,b,N)):K=>v(K,b,N))({x:C+p*Math.cos(k),y:Y+p*Math.sin(k)});z.push(j)}st(z,!0,$(y.data.layer))}else{const C=(e?p=>e.tx(v(p,b,N)):p=>v(p,b,N))({x:y.data.cx||0,y:y.data.cy||0}),Y=(l+u)/2;I.push({type:"CIRCLE",data:{cx:C.x,cy:C.y,r:(y.data.r||0)*Y,layer:$(y.data.layer)}})}else if(_==="ARC"){const C=y.data.cx||0,Y=y.data.cy||0,p=y.data.r||0,X=(y.data.a1||0)*Math.PI/180,R=(y.data.a2||0)*Math.PI/180;if(g){const z=R>=X?R-X:R+2*Math.PI-X,F=Math.max(Math.abs(l*p),Math.abs(u*p)),k=Et(F,typeof V<"u"?V:.1,z),j=[];for(let K=0;K<=k;K++){const lt=X+z*(K/k),St=(e?nt=>e.tx(v(nt,b,N)):nt=>v(nt,b,N))({x:C+p*Math.cos(lt),y:Y+p*Math.sin(lt)});j.push(St)}st(j,!1,$(y.data.layer))}else{const z=(e?k=>e.tx(v(k,b,N)):k=>v(k,b,N))({x:C,y:Y}),F=(l+u)/2;I.push({type:"ARC",data:{cx:z.x,cy:z.y,r:p*F,a1:(y.data.a1||0)+(t.data.rot||0),a2:(y.data.a2||0)+(t.data.rot||0),layer:$(y.data.layer)}})}}else if(_==="LWPOLYLINE"||_==="POLYLINE"){const C=[],Y=y.verts||[];for(let p=0;p<Y.length-1;p++){const X=Y[p],R=Y[p+1];if(!(Number.isFinite(X.bulge)&&Math.abs(X.bulge)>1e-9)||!g){const F=(e?k=>e.tx(v(k,b,N)):k=>v(k,b,N))({x:X.x||0,y:X.y||0});if(C.push(F),p===Y.length-2){const k=(e?j=>e.tx(v(j,b,N)):j=>v(j,b,N))({x:R.x||0,y:R.y||0});C.push(k)}}else{const F=X.x||0,k=X.y||0,j=R.x||0,K=R.y||0,lt=X.bulge,St=Math.hypot(j-F,K-k),nt=4*Math.atan(lt),ft=Math.abs(St/(2*Math.sin(nt/2))),Me=(F+j)/2,be=(k+K)/2,qt=-(K-k),zt=j-F,Qt=ft*Math.cos(nt/2),Gt=lt>=0?1:-1,Ht=Math.hypot(qt,zt)||1,Jt=Me+Gt*(qt/Ht)*Qt,Zt=be+Gt*(zt/Ht)*Qt,Le=Math.atan2(k-Zt,F-Jt),Bt=nt,Ee=Math.max(Math.abs(l*ft),Math.abs(u*ft)),te=Et(Ee,typeof V<"u"?V:.1,Math.abs(Bt));for(let dt=0;dt<te;dt++){const it=Le+Bt*(dt/te),Ne={x:Jt+ft*Math.cos(it),y:Zt+ft*Math.sin(it)},Pe=(e?Xt=>e.tx(v(Xt,b,N)):Xt=>v(Xt,b,N))(Ne);C.push(Pe)}if(p===Y.length-2){const dt=(e?it=>e.tx(v(it,b,N)):it=>v(it,b,N))({x:R.x||0,y:R.y||0});C.push(dt)}}}st(C,!!(y.data.flags&1),$(y.data.layer))}else if(_==="INSERT"){const C={data:{name:y.data.name,x:y.data.x,y:y.data.y,sx:y.data.sx,sy:y.data.sy,rot:y.data.rot,rows:y.data.rows,cols:y.data.cols,rowSpacing:y.data.rowSpacing,colSpacing:y.data.colSpacing}},Y=Nt(C,{tx:p=>e?e.tx(v(p,b,N)):v(p,b,N)});for(const p of Y)I.push(p)}}for(let y=0;y<n;y++)for(let b=0;b<i;b++){const N=b*h,_=y*f,C=E*N+m*_,Y=M*N+S*_,p=o+C,X=c+Y;for(const R of s.ents||[])rt(R,p,X)}return I}function ae(t){try{for(let e=1;e<t.length-1;e++){const a=(t[e]||"").trim(),s=(t[e-1]||"").trim();if(a==="$INSUNITS"&&s==="9")for(let n=e+1;n<Math.min(e+50,t.length-1);n+=2){const i=(t[n]||"").trim(),f=(t[n+1]||"").trim();if(i==="70"){const h=parseInt(f,10);return Number.isFinite(h)?h:null}}}}catch{}return null}function ne(t){switch(t){case 1:return 25.4;case 2:return 304.8;case 3:return 1609344;case 4:return 1;case 5:return 10;case 6:return 1e3;case 7:return 1e6;case 8:return 254e-7;case 9:return .0254;case 10:return 914.4;case 11:return 1e-7;case 12:return 1e-6;case 13:return .001;case 14:return 100;case 15:return 1e4;case 16:return 1e5;default:return 1}}const Ot=ae(Z),w=ne(Ot);function se(t){try{let e=null,a=null,s=null,n=null;for(let i=1;i<t.length-1;i++){const f=(t[i]||"").trim(),h=(t[i-1]||"").trim();if(f==="$EXTMIN"&&h==="9")for(let o=i+1;o<Math.min(i+50,t.length-1);o+=2){const c=(t[o]||"").trim(),l=(t[o+1]||"").trim();if(c==="10"?e=parseFloat(l):c==="20"&&(a=parseFloat(l)),e!==null&&a!==null)break}if(f==="$EXTMAX"&&h==="9")for(let o=i+1;o<Math.min(i+50,t.length-1);o+=2){const c=(t[o]||"").trim(),l=(t[o+1]||"").trim();if(c==="10"?s=parseFloat(l):c==="20"&&(n=parseFloat(l)),s!==null&&n!==null)break}}return{minX:e,minY:a,maxX:s,maxY:n}}catch{return{minX:null,minY:null,maxX:null,maxY:null}}}const G=se(Z);function ie(t){try{const e=[];let a=0,s=!1,n=!1;for(;a<t.length-1;){const i=(t[a]||"").trim(),f=(t[a+1]||"").trim();if(i==="0"&&f==="SECTION"&&(s=!1,n=!1),i==="2"&&f==="TABLES"&&(s=!0),s&&i==="0"&&f==="TABLE"){const h=(t[a+2]||"").trim(),o=(t[a+3]||"").trim();n=h==="2"&&o==="LAYER"}if(i==="0"&&f==="ENDSEC"&&(s=!1,n=!1),s&&n&&i==="0"&&f==="LAYER"){let h="",o=7,c=0,l=a+2;for(;l<t.length-1;l+=2){const x=(t[l]||"").trim(),g=(t[l+1]||"").trim();if(x==="0")break;x==="2"?h=g||h:x==="62"?o=parseInt(g||"7",10):x==="70"&&(c=parseInt(g||"0",10))}const u=o>=0&&(c&1)===0;h&&u&&e.push(h)}a+=2}return e}catch{return[]}}let Pt,Tt=!1;for(;Pt=yt();)if(Pt.code===0&&xt(Pt.value)==="SECTION"){let t=null,e;for(;e=yt();)if(e.code===2)t=xt(e.value);else if(e.code===0){ht-=2;break}if(t==="ENTITIES"){Tt=!0;break}}if(!Tt)throw new Error("Нет секции ENTITIES");function oe(t){const e=[],a=new Map;for(let o=0;o<t.length-1;o++){const c=(t[o]||"").trim(),l=(t[o-1]||"").trim();if(c==="BLOCK"&&l==="0"){let u=null,x={x:0,y:0};for(let g=o+1;g<t.length-1;g+=2){const P=(t[g]||"").trim(),L=(t[g+1]||"").trim();if(P==="2"&&!u&&(u=L),P==="10"&&(x.x=parseFloat(L)),P==="20"&&(x.y=parseFloat(L)),P==="0"&&(L||"").trim().toUpperCase()==="ENDBLK"){o=g+1;break}}if(u){const g={name:u,basePoint:x,ents:[]};e.push(g),a.set(u,g)}}}let s=0,n=null,i=null,f=null;function h(o){return String(o||"").toUpperCase()}for(;s<t.length-1;){const o=(t[s]||"").trim(),c=(t[s+1]||"").trim();if(s+=2,o==="0"&&h(c)==="BLOCK"){n=null,i=null,f={name:null,base:{x:0,y:0}};continue}if(f){if(o==="2"&&!f.name){f.name=c;continue}if(o==="10"){f.base.x=parseFloat(c);continue}if(o==="20"){f.base.y=parseFloat(c);continue}if(o==="0"&&h(c)==="ENDBLK"){const u=a.get(f.name||"");u&&(u.basePoint=f.base),f=null,n=null,i=null;continue}if(o==="0"){const u=h(c);if(u==="VERTEX"&&i){n=i;continue}if(u==="SEQEND"&&i){const x=a.get(f.name||"");x&&x.ents.push(i),i=null,n=null;continue}if(n&&i!==n){const x=a.get(f.name||"");x&&x.ents.push(n)}n={type:u,data:{},verts:[]},u==="POLYLINE"&&(i=n);continue}if(!n)continue;if(o==="8"){n.data.layer=(c||"").trim();continue}const l=parseFloat(c);switch(n.type){case"LINE":o==="10"?n.data.x1=l:o==="20"?n.data.y1=l:o==="11"?n.data.x2=l:o==="21"&&(n.data.y2=l);break;case"CIRCLE":o==="10"?n.data.cx=l:o==="20"?n.data.cy=l:o==="40"&&(n.data.r=l);break;case"ARC":o==="10"?n.data.cx=l:o==="20"?n.data.cy=l:o==="40"?n.data.r=l:o==="50"?n.data.a1=l:o==="51"&&(n.data.a2=l);break;case"LWPOLYLINE":o==="10"?n.verts.push({x:l}):o==="20"?n.verts.length&&(n.verts[n.verts.length-1].y=l):o==="42"?n.verts.length&&(n.verts[n.verts.length-1].bulge=l):o==="70"&&(n.data.flags=parseInt(c,10));break;case"POLYLINE":case"VERTEX":o==="10"?n.verts.push({x:l}):o==="20"?n.verts.length&&(n.verts[n.verts.length-1].y=l):o==="42"?n.verts.length&&(n.verts[n.verts.length-1].bulge=l):o==="70"&&(n.data.flags=parseInt(c,10));break}}}return{blocks:e,map:a}}const Ft=oe(Z),ot=[];let d,r=null,H=null;const At={LINE:1,CIRCLE:1,ARC:1,LWPOLYLINE:1,POLYLINE:1,VERTEX:1,SEQEND:1,ELLIPSE:1,SPLINE:1,INSERT:1,POINT:1};for(;(d=yt())&&!(d.code===0&&xt(d.value)==="ENDSEC");){if(d.code===0){const e=xt(d.value);if(e==="VERTEX"&&H){r=H;continue}if(e==="SEQEND"&&H){ot.push(H),H=null,r=null;continue}r&&At[r.type]&&r!==H&&ot.push(r),r={type:e,data:{},verts:[]},e==="POLYLINE"&&(H=r);continue}if(!r)continue;if(d.code===8){r.data.layer=(d.value||"").trim();continue}const t=parseFloat(d.value);switch(r.type){case"LINE":d.code===10?r.data.x1=t:d.code===20?r.data.y1=t:d.code===11?r.data.x2=t:d.code===21&&(r.data.y2=t);break;case"CIRCLE":d.code===10?r.data.cx=t:d.code===20?r.data.cy=t:d.code===40&&(r.data.r=t);break;case"ARC":d.code===10?r.data.cx=t:d.code===20?r.data.cy=t:d.code===40?r.data.r=t:d.code===50?r.data.a1=t:d.code===51&&(r.data.a2=t);break;case"LWPOLYLINE":d.code===10?r.verts.push({x:t}):d.code===20?r.verts.length&&(r.verts[r.verts.length-1].y=t):d.code===42?r.verts.length&&(r.verts[r.verts.length-1].bulge=t):d.code===70&&(r.data.flags=parseInt(d.value,10));break;case"POLYLINE":case"VERTEX":d.code===10?r.verts.push({x:t}):d.code===20?r.verts.length&&(r.verts[r.verts.length-1].y=t):d.code===42&&r.verts.length&&(r.verts[r.verts.length-1].bulge=t);break;case"ELLIPSE":d.code===10?r.data.cx=t:d.code===20?r.data.cy=t:d.code===11?r.data.mx=t:d.code===21?r.data.my=t:d.code===40?r.data.ratio=t:d.code===41?r.data.t1=t:d.code===42&&(r.data.t2=t);break;case"SPLINE":if(d.code===70)r.data.flags=parseInt(d.value,10);else if(d.code===71)r.data.degree=parseInt(d.value,10);else if(d.code===73)r.data.nCtrl=parseInt(d.value,10);else if(d.code===74)r.data.nFit=parseInt(d.value,10);else if(d.code===40)r.data.knots||(r.data.knots=[]),r.data.knots.push(t);else if(d.code===10)r.data.ctrlPts||(r.data.ctrlPts=[]),r.data.ctrlPts.push({x:t});else if(d.code===20){const e=r.data.ctrlPts;e&&e.length&&(e[e.length-1].y=t)}else if(d.code===11)r.data.fitPts||(r.data.fitPts=[]),r.data.fitPts.push({x:t});else if(d.code===21){const e=r.data.fitPts;e&&e.length&&(e[e.length-1].y=t)}break;case"POINT":d.code===10?r.data.x=t:d.code===20&&(r.data.y=t);break;case"INSERT":d.code===2?r.data.name=t:d.code===10?r.data.x=t:d.code===20?r.data.y=t:d.code===41?r.data.sx=t:d.code===42?r.data.sy=t:d.code===50?r.data.rot=t:d.code===70?r.data.rows=parseInt(d.value,10):d.code===71?r.data.cols=parseInt(d.value,10):d.code===44?r.data.colSpacing=t:d.code===45&&(r.data.rowSpacing=t);break}}r&&r!==H&&At[r.type]&&ot.push(r);const O=[];let It=0;const $t=[],B=new Set,T=[],Dt=[];function tt(t){t&&t.type&&isFinite(t.len)&&t.len>=0&&(t.id=O.length,O.push(t),It+=t.len)}function ce(t,e){T.push(e),Dt.push({code:t,message:e})}function mt(){for(let t=0;t<arguments.length;t++){const e=arguments[t];if(!(Number.isFinite(e)&&!Number.isNaN(e)))return!1}return!0}function re({cx:t,cy:e,mx:a,my:s,ratio:n=1,startParam:i=0,endParam:f=2*Math.PI}){const h=t*w,o=e*w,c=a*w,l=s*w,u=Math.hypot(c,l);if(!(u>0)||!(n>0))return{pts:[],closed:!1,lenM:0};const x=c/u,g=l/u,P=-g,L=x,E=u*n;let M=Number.isFinite(i)?i:0,m=Number.isFinite(f)?f:2*Math.PI;for(;m<M;)m+=2*Math.PI;const S=Math.max(0,Math.min(2*Math.PI,m-M)),J=Math.pow(u-E,2)/Math.pow(u+E,2),$=Math.PI*(u+E)*(1+3*J/(10+Math.sqrt(4-3*J)))*(S/(2*Math.PI)),v=Math.max(8,Math.min(2048,Math.ceil($/Math.max(V,1e-6)))),I=[];for(let D=0;D<=v;D++){const at=M+S*(D/v),Mt=h+u*Math.cos(at)*x+E*Math.sin(at)*P,bt=o+u*Math.cos(at)*g+E*Math.sin(at)*L;I.push({x:Mt,y:bt})}const st=S>=2*Math.PI-.001||Math.hypot(I[0].x-I[I.length-1].x,I[0].y-I[I.length-1].y)<=ut;let rt=0;for(let D=0;D<I.length-1;D++)rt+=Math.hypot(I[D+1].x-I[D].x,I[D+1].y-I[D].y);return st&&(rt+=Math.hypot(I[0].x-I[I.length-1].x,I[0].y-I[I.length-1].y)),{pts:I,closed:st,lenM:rt/1e3}}function le(t){const e=Number.isFinite(t.degree)?t.degree:3,a=(t.ctrlPts||[]).map(c=>({x:c.x*w,y:c.y*w})),s=(t.fitPts||[]).map(c=>({x:c.x*w,y:c.y*w})),n=Array.isArray(t.knots)?t.knots.slice():[];let i=[];function f(c){let l=0;for(let u=0;u<c.length-1;u++)l+=Math.hypot(c[u+1].x-c[u].x,c[u+1].y-c[u].y);return l}if(s.length>=2){for(let c=0;c<s.length-1;c++){const l=s[c],u=s[c+1],x=Math.hypot(u.x-l.x,u.y-l.y),g=Math.max(1,Math.ceil(x/Math.max(V,1e-6)));for(let P=0;P<g;P++){const L=P/g;i.push({x:l.x+(u.x-l.x)*L,y:l.y+(u.y-l.y)*L})}}i.push(s[s.length-1])}else if(a.length>=e+1&&n.length>=a.length+e+1){let g=function(L){let E=e,M=n.length-e-1;if(L>=n[M])return M-1;if(L<=n[E])return E;let m=Math.floor((E+M)/2);for(;L<n[m]||L>=n[m+1];)L<n[m]?M=m:E=m,m=Math.floor((E+M)/2);return m},P=function(L){const E=g(L),M=[];for(let m=0;m<=e;m++)M[m]={x:a[E-e+m].x,y:a[E-e+m].y};for(let m=1;m<=e;m++)for(let S=e;S>=m;S--){const J=E-e+S,ct=n[J+1]-n[J-m+1],$=ct!==0?(L-n[J-m+1])/ct:0,v=(1-$)*M[S-1].x+$*M[S].x,I=(1-$)*M[S-1].y+$*M[S].y;M[S]={x:v,y:I}}return M[e]};const c=n[e],l=n[n.length-e-1],u=f(a),x=Math.max(16,Math.min(4096,Math.ceil(u/Math.max(V,1e-6))));for(let L=0;L<=x;L++){const E=c+(l-c)*(L/x);i.push(P(E))}}const h=!!(t.flags&1)||i.length>1&&Math.hypot(i[0].x-i[i.length-1].x,i[0].y-i[i.length-1].y)<=ut;let o=0;for(let c=0;c<i.length-1;c++)o+=Math.hypot(i[c+1].x-i[c].x,i[c+1].y-i[c].y);return h&&i.length>1&&(o+=Math.hypot(i[0].x-i[i.length-1].x,i[0].y-i[i.length-1].y)),{pts:i,closed:h,lenM:o/1e3}}const vt=[];for(const t of ot){if(t&&t.type==="INSERT"){const e=Nt(t);for(const a of e)vt.push(a);continue}vt.push(t)}for(const t of vt){if(!t||!t.type){T.push("Entity missing type information");continue}if(t.type==="LINE"){const{x1:e,y1:a,x2:s,y2:n}=t.data;if(!mt(e,a,s,n)){T.push(`LINE entity has invalid coordinates: (${e},${a}) -> (${s},${n})`);continue}const i=e*w,f=a*w,h=s*w,o=n*w,c=Math.hypot(h-i,o-f)/1e3;if(c<=0){T.push("LINE entity has zero length");continue}tt({type:"LINE",len:c,start:[i,f],layer:t.data.layer,raw:{x1:i,y1:f,x2:h,y2:o}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="CIRCLE"){const{cx:e=0,cy:a=0,r:s=0}=t.data;if(!mt(e,a,s)||s<=0){T.push(`CIRCLE entity has invalid parameters: center(${e},${a}) r=${s}`);continue}const n=e*w,i=a*w,f=s*w;tt({type:"CIRCLE",len:2*Math.PI*f/1e3,start:[n,i],layer:t.data.layer,raw:{cx:n,cy:i,r:f}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="ARC"){const{cx:e=0,cy:a=0,r:s=0,a1:n=0,a2:i=0}=t.data;if(!mt(e,a,s,n,i)||s<=0){T.push(`ARC entity has invalid parameters: center(${e},${a}) r=${s} a1=${n} a2=${i}`);continue}const f=e*w,h=a*w,o=s*w;let c=n*Math.PI/180,u=i*Math.PI/180-c;if(u<0&&(u+=2*Math.PI),u<=0){T.push(`ARC entity has invalid angle range: ${n}°..${i}°`);continue}tt({type:"ARC",len:o*u/1e3,start:[f+o*Math.cos(c),h+o*Math.sin(c)],layer:t.data.layer,raw:{cx:f,cy:h,r:o,a1:n,a2:i}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="LWPOLYLINE"||t.type==="POLYLINE"){let s=function(c,l,u){const x=l.x-c.x,g=l.y-c.y,P=Math.hypot(x,g),L=Number(u)||0;if(!L)return P;const E=4*Math.atan(L),M=Math.sin(E/2),m=M===0?P/2:P/2/Math.abs(M);return Math.abs(m*E)};const e=(t.verts||[]).filter(c=>Number.isFinite(c.x)&&Number.isFinite(c.y));if(e.length<2){T.push(`${t.type} entity has insufficient valid points: ${e.length}`);continue}const a=e.map(c=>({x:c.x*w,y:c.y*w,bulge:Number.isFinite(c.bulge)?c.bulge:0}));let n=0;for(let c=0;c<a.length-1;c++)n+=s(a[c],a[c+1],a[c].bulge);const i=a[0],f=a[a.length-1],h=!!(t.data.flags&1)||a.length>2&&Math.hypot(i.x-f.x,i.y-f.y)<=ut;if(h&&(n+=s(f,i,f.bulge)),n<=0){T.push(`${t.type} entity has zero total length`);continue}const o=a.map(c=>({x:c.x,y:c.y}));tt({type:"POLY",len:n/1e3,start:[i.x,i.y],layer:t.data.layer,raw:{pts:o,closed:h}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="ELLIPSE"){const{cx:e=0,cy:a=0,mx:s=0,my:n=0,ratio:i=1,t1:f=0,t2:h=2*Math.PI}=t.data;if(!mt(e,a,s,n,i)){T.push("ELLIPSE entity has invalid parameters");continue}const o=re({cx:e,cy:a,mx:s,my:n,ratio:i,startParam:f,endParam:h});if(o.pts.length<2||o.lenM<=0){T.push("ELLIPSE approximation failed");continue}const c=o.pts[0];tt({type:"POLY",len:o.lenM,start:[c.x,c.y],layer:t.data.layer,raw:{pts:o.pts,closed:o.closed}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="SPLINE"){const e=le({degree:t.data.degree,ctrlPts:t.data.ctrlPts,fitPts:t.data.fitPts,knots:t.data.knots,flags:t.data.flags|0});if(e.pts.length<2||e.lenM<=0){T.push("SPLINE approximation failed");continue}const a=e.pts[0];tt({type:"POLY",len:e.lenM,start:[a.x,a.y],raw:{pts:e.pts,closed:e.closed}})}else if(t.type==="POINT"){const e=t.data.x,a=t.data.y;if(!(Number.isFinite(e)&&Number.isFinite(a))){T.push("POINT entity has invalid coordinates");continue}const s=e*w,n=a*w;tt({type:"POINT",len:0,start:[s,n],layer:t.data.layer,raw:{x:s,y:n}}),t.data.layer&&B.add(t.data.layer)}else if(t.type==="INSERT"){const e=Nt(t);for(const a of e)ot.push(a);continue}}const wt=ut;function _t(t){if(!t)return[];if(t.type==="LINE"){const e=t.raw;return[{x:e.x1,y:e.y1},{x:e.x2,y:e.y2}]}if(t.type==="ARC"){const e=t.raw,a=e.cx||0,s=e.cy||0,n=e.r||0;let i=(e.a1||0)*Math.PI/180,f=(e.a2||0)*Math.PI/180;return f<i&&(f+=2*Math.PI),[{x:a+n*Math.cos(i),y:s+n*Math.sin(i)},{x:a+n*Math.cos(f),y:s+n*Math.sin(f)}]}if(t.type==="POLY"){const e=t.raw.pts||[];return e.length?t.raw.closed?[]:[{x:e[0].x,y:e[0].y},{x:e[e.length-1].x,y:e[e.length-1].y}]:[]}return[]}function fe(t){if(t.type==="CIRCLE"){const e=t.raw;return[{x:e.cx+e.r,y:e.cy}]}if(t.type==="POLY"&&t.raw.closed){const e=t.raw.pts||[];if(e.length)return[{x:e[0].x,y:e[0].y}]}return _t(t)}const et=[];for(let t=0;t<O.length;t++){const e=O[t];if(!e||e.type==="CIRCLE"||e.type==="POLY"&&e.raw&&e.raw.closed)continue;const a=_t(e);for(const s of a)et.push({x:s.x,y:s.y,ent:t})}const q=[],Ct=new Map;function de(t,e){const a=q[t],s=et[e];a.members.push(e);const n=a.members.length;a.x+=(s.x-a.x)/n,a.y+=(s.y-a.y)/n,Ct.set(e,t)}for(let t=0;t<et.length;t++){const e=et[t];let a=-1,s=1/0;for(let n=0;n<q.length;n++){const i=q[n],f=Math.hypot(e.x-i.x,e.y-i.y);f<=wt&&f<s&&(s=f,a=n)}a<0?(q.push({x:e.x,y:e.y,members:[t]}),Ct.set(t,q.length-1)):de(a,t)}const pt=new Array(O.length);for(let t=0;t<O.length;t++)pt[t]=new Set;for(let t=0;t<q.length;t++){const e=new Set;for(const s of q[t].members)e.add(et[s].ent);const a=Array.from(e);for(let s=0;s<a.length;s++)for(let n=s+1;n<a.length;n++)pt[a[s]].add(a[n]),pt[a[n]].add(a[s])}const Yt=new Map;for(let t=0;t<et.length;t++){const e=et[t].ent,a=Ct.get(t);let s=Yt.get(e);s||(s=[],Yt.set(e,s)),s.push(a)}const gt=new Array(O.length).fill(!1);let jt=0;for(let t=0;t<O.length;t++){if(gt[t])continue;const e=[t];gt[t]=!0;const a=[];for(;e.length;){const h=e.shift();a.push(h);const o=O[h];if(o&&!(o.type==="CIRCLE"||o.type==="POLY"&&o.raw&&o.raw.closed))for(const c of pt[h])gt[c]||(gt[c]=!0,e.push(c))}let s=!1,n=!1,i=!1;for(const h of a){const o=O[h];o&&(o.type==="CIRCLE"?s=!0:o.type==="POLY"&&o.raw&&o.raw.closed?n=!0:i=!0)}let f=!1;if(s||n)f=!0;else if(i){const h=new Map,o=new Set;for(const l of a){const u=Yt.get(l)||[];for(const x of u)h.set(x,(h.get(x)||0)+1),o.add(x)}const c=[];for(const l of o)(h.get(l)||0)<=1&&c.push(l);if(o.size>0)if(c.length===0)f=!0;else{let u=function(x){const g=x.length;if(g===0)return!0;if(g%2===1||g>12)return!1;for(let E=0;E<g;E++){let M=!1;for(let m=0;m<g;m++){if(E===m)continue;if(Math.hypot(x[E].x-x[m].x,x[E].y-x[m].y)<=wt){M=!0;break}}if(!M)return!1}const P=new Array(g).fill(!1);function L(E){if(E===g)return!0;let M=0;for(;M<g&&P[M];)M++;P[M]=!0;for(let m=M+1;m<g;m++){if(P[m])continue;if(Math.hypot(x[M].x-x[m].x,x[M].y-x[m].y)<=wt){if(P[m]=!0,L(E+2))return!0;P[m]=!1}}return P[M]=!1,!1}return L(0)};const l=c.map(x=>({x:q[x].x,y:q[x].y}));f=u(l)}}if(f){const h=[];for(const o of a){const c=fe(O[o]);for(const l of c)h.push(l)}if(h.length){h.sort((c,l)=>c.x===l.x?c.y-l.y:c.x-l.x);const o=h[0];$t.push([o.x,o.y])}jt++}}const W=[];function ue(t){let e=0;for(let a=0;a<t.length;a++){const s=t[a],n=t[(a+1)%t.length];e+=s.x*n.y-n.x*s.y}return .5*e}function kt(t){if(t.type==="LINE"){const{x1:e,y1:a,x2:s,y2:n}=t.raw;return{minX:Math.min(e,s),minY:Math.min(a,n),maxX:Math.max(e,s),maxY:Math.max(a,n)}}if(t.type==="CIRCLE"){const{cx:e,cy:a,r:s}=t.raw;return{minX:e-s,minY:a-s,maxX:e+s,maxY:a+s}}if(t.type==="ARC"){const{cx:e,cy:a,r:s}=t.raw;return{minX:e-s,minY:a-s,maxX:e+s,maxY:a+s}}if(t.type==="POLY"){const e=t.raw.pts||[];let a=1/0,s=1/0,n=-1/0,i=-1/0;for(const f of e)a=Math.min(a,f.x),s=Math.min(s,f.y),n=Math.max(n,f.x),i=Math.max(i,f.y);return{minX:a,minY:s,maxX:n,maxY:i}}if(t.type==="POINT"){const{x:e,y:a}=t.raw;return{minX:e,minY:a,maxX:e,maxY:a}}return{minX:0,minY:0,maxX:0,maxY:0}}function Ut(t,e,a){let s=!1;for(let n=0,i=t.length-1;n<t.length;i=n++){const f=t[n].x,h=t[n].y,o=t[i].x,c=t[i].y;h>a!=c>a&&e<(o-f)*(a-h)/(c-h+1e-9)+f&&(s=!s)}return s}function he(t,e){if(t.bbox.minX>e.bbox.minX||t.bbox.maxX<e.bbox.maxX||t.bbox.minY>e.bbox.minY||t.bbox.maxY<e.bbox.maxY)return!1;const a=e.rep;if(t.kind==="poly")return e.kind==="circle"?Ut(t.pts,e.cx,e.cy):Ut(t.pts,a.x,a.y);{const s=(e.kind==="circle"?e.cx:a.x)-t.cx,n=(e.kind==="circle"?e.cy:a.y)-t.cy,i=Math.hypot(s,n);return e.kind==="circle"?i+e.r<=t.r+1e-6:i<=t.r+1e-6}}for(const t of O)if(t.type==="CIRCLE"){const{cx:e,cy:a,r:s}=t.raw;W.push({id:t.id,ent:t,kind:"circle",area:Math.PI*s*s,depth:0,bbox:kt(t),rep:{x:e,y:a},cx:e,cy:a,r:s})}else if(t.type==="POLY"&&t.raw.closed){const e=t.raw.pts,a=ue(e),s=e[0];W.push({id:t.id,ent:t,kind:"poly",area:Math.abs(a),signedArea:a,depth:0,bbox:kt(t),rep:s,pts:e})}for(let t=0;t<W.length;t++){let e=0;for(let a=0;a<W.length;a++)t!==a&&he(W[a],W[t])&&e++;W[t].depth=e}const ye=W.slice().sort((t,e)=>e.depth-t.depth||t.area-e.area).map(t=>t.id);let U={minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};for(const t of O){const e=kt(t);U.minX=Math.min(U.minX,e.minX),U.minY=Math.min(U.minY,e.minY),U.maxX=Math.max(U.maxX,e.maxX),U.maxY=Math.max(U.maxY,e.maxY)}isFinite(U.minX)||(U={minX:0,minY:0,maxX:0,maxY:0});let Kt=0;for(const t of W){const e=t.depth%2===0?1:-1;Kt+=e*(t.area||0)}const xe={units:"mm",insUnits:Ot,extMin:G.minX!=null&&G.minY!=null?{x:G.minX*w,y:G.minY*w}:void 0,extMax:G.maxX!=null&&G.maxY!=null?{x:G.maxX*w,y:G.maxY*w}:void 0},me=ie(Z)||[],pe=Array.from(new Set([...me,...B])),ge=(Ft.blocks||[]).map(t=>({name:t.name,basePoint:t.basePoint}));return{entities:O,totalLen:It,lengthTotal:It,pierceCount:jt,piercePts:$t,loops:W,cutOrder:ye,validationErrors:T,validationErrorsEx:Dt,blocks:ge,bbox:U,areaTotal:Kt,header:xe,layers:pe}}})();
