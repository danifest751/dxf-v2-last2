function O(e,t,n){try{if(!t||!n)throw new Error("Canvas или layout не найдены");return e.combinedNesting&&e.combinedNesting.sheets&&e.combinedNesting.sheets.length>1?D(e,t,e.combinedNesting):C(t,n),!0}catch(l){throw console.error("JPEG export error:",l),new Error(`Ошибка экспорта JPEG: ${l.message}`)}}function C(e,t){const n=document.createElement("canvas"),l=n.getContext("2d"),o=2;n.width=e.width*o,n.height=e.height*o,l.scale(o,o),l.fillStyle="#ffffff",l.fillRect(0,0,e.width,e.height),l.drawImage(e,0,0),j(l,t,e.width,e.height),n.toBlob(i=>{const a=URL.createObjectURL(i),s=document.createElement("a");s.href=a,s.download=`DXF_PRO_Layout_${new Date().getTime()}.jpg`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)},"image/jpeg",.9)}function D(e,t,n){const{sheets:l}=n,o=+document.getElementById("sW").value,i=+document.getElementById("sH").value;l.forEach((a,s)=>{const c=document.createElement("canvas"),d=c.getContext("2d"),h=2,p=Math.max(800,o*.3),r=Math.max(600,i*.3);c.width=p*h,c.height=r*h,d.scale(h,h),d.fillStyle="#ffffff",d.fillRect(0,0,p,r),U(d,a,o,i,p,r,s+1),c.toBlob(b=>{const m=URL.createObjectURL(b),f=document.createElement("a");f.href=m,f.download=`DXF_PRO_Layout_Sheet_${s+1}_${new Date().getTime()}.jpg`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(m)},"image/jpeg",.9)})}function U(e,t,n,l,o,i,a){const c=o-80,d=i-2*40-60,h=c/n,p=d/l,r=Math.min(h,p),b=n*r,m=l*r,f=(o-b)/2,y=70;e.strokeStyle="#000000",e.lineWidth=2,e.rect(f,y,b,m),e.stroke();const S=10*r;e.strokeStyle="#999999",e.lineWidth=1,e.setLineDash([5,5]),e.rect(f+S,y+S,b-2*S,m-2*S),e.stroke(),e.setLineDash([]),e.fillStyle="#3b82f6",e.strokeStyle="#1e40af",e.lineWidth=1,t.parts.forEach(g=>{const u=f+g.x*r,$=y+g.y*r,R=g.placedWidth*r,w=g.placedHeight*r;if(e.fillRect(u,$,R,w),e.strokeRect(u,$,R,w),R>30&&w>20){e.fillStyle="#ffffff",e.font="10px Arial",e.textAlign="center";const T=g.file?g.file.name.substring(0,8):"Деталь";e.fillText(T,u+R/2,$+w/2+3),e.fillStyle="#3b82f6"}}),e.fillStyle="#000000",e.font="bold 16px Arial",e.textAlign="center",e.fillText(`DXF PRO - Лист ${a}`,o/2,20),e.font="12px Arial",e.textAlign="left";const L=y+m+20;e.fillText(`Размер листа: ${n} x ${l} мм`,f,L),e.fillText(`Деталей на листе: ${t.parts.length}`,f,L+15);const A=t.parts.reduce((g,u)=>g+u.placedWidth*u.placedHeight,0),E=n*l,k=(A/E*100).toFixed(1);e.fillText(`Эффективность: ${k}%`,f,L+30)}function j(e,t,n,l){var d,h;e.fillStyle="#000000",e.font="bold 16px Arial",e.textAlign="center",e.fillText("DXF PRO - Раскладка",n/2,20),e.font="12px Arial",e.textAlign="left";const o=l-40;let i="";t.sheets!==void 0&&(i+=`Листов: ${t.sheets} `),t.totalSheets!==void 0&&(i+=`Листов: ${t.totalSheets} `),t.efficiency!==void 0&&(i+=`Эффективность: ${t.efficiency.toFixed(1)}% `);const a=(d=document.getElementById("sW"))==null?void 0:d.value,s=(h=document.getElementById("sH"))==null?void 0:h.value;a&&s&&(i+=`Размер листа: ${a}x${s}мм`),e.fillText(i,10,o),e.font="10px Arial",e.textAlign="right";const c=new Date;e.fillText(`${c.toLocaleDateString("ru-RU")} ${c.toLocaleTimeString("ru-RU")}`,n-10,o)}export{O as exportLayoutAsJPEG};
